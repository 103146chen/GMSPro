<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GradeFlow 成績查詢系統 (Demo)</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; }
    
    /* 動畫效果 */
    .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .animate-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
    @keyframes shake {
        10%, 90% { transform: translate3d(-1px, 0, 0); }
        20%, 80% { transform: translate3d(2px, 0, 0); }
        30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
        40%, 60% { transform: translate3d(4px, 0, 0); }
    }

    /* 捲軸隱藏 */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* 五標自訂顏色 */
    .val-bottom { color: #dc2626; background: #fef2f2; }
    .val-back { color: #ea580c; background: #fff7ed; }
    .val-avg { color: #059669; background: #ecfdf5; }
    .val-front { color: #2563eb; background: #eff6ff; }
    .val-top { color: #7c3aed; background: #f5f3ff; }
  </style>

  <script>
    // 啟動點
    window.onload = function() {
       checkSystemInit();
    };

    function checkSystemInit() {
        // 檢查 sessionStorage 中是否有初始化標記
        const isInit = sessionStorage.getItem('SYS_INIT');
        
        if (isInit === 'true') {
            // 已初始化 -> 進入登入流程
            document.getElementById('setup-card').classList.add('hidden');
            autoLogin(); 
        } else {
            // 未初始化 -> 顯示設定畫面
            document.getElementById('setup-card').classList.remove('hidden');
            document.getElementById('login-card').classList.add('hidden');
            document.getElementById('dashboard').classList.add('hidden');
        }
    }
    
    // 模擬資料產生器
    function generateMockPayload() {
        const subjects = ['國文', '英語', '數學', '社會', '自然'];
        const types = ['L1習作', 'L2習作', '第一次小考', '第二次小考', '第一次段考', '期末報告', '期末考'];
        let payload = [];
        
        // 模擬日期 (從 3 個月前開始)
        let baseDate = new Date();
        baseDate.setMonth(baseDate.getMonth() - 3);

        subjects.forEach(sub => {
            let currentDate = new Date(baseDate);
            types.forEach((task, index) => {
                // 每個作業間隔 7-14 天
                currentDate.setDate(currentDate.getDate() + Math.floor(Math.random() * 7) + 7);
                const dateStr = currentDate.toISOString().split('T')[0].replace(/-/g, '/').substring(5); // MM/DD

                // 模擬該次作業的全班成績 (30人)
                const classScores = [];
                for(let i=0; i<30; i++) {
                    // 產生常態分佈的分數 (平均 75, 標準差 15)
                    let s = Math.floor(Math.random() * 30 + 60 + (Math.random() * 20 - 10)); 
                    s = Math.min(100, Math.max(0, s)); // 限制 0-100
                    classScores.push(s);
                }
                
                // 我的成績 (取第 5 位同學)
                const myScore = classScores[4]; 
                
                // 計算排名
                classScores.sort((a,b) => b - a);
                const myRank = classScores.indexOf(myScore) + 1;

                // 計算統計數據
                const stats = calculateStats(classScores);

                payload.push({
                    subject: sub,
                    task: task,
                    score: myScore,
                    rank: myRank,
                    sheet: index > 4 ? "期末成績" : "平時成績",
                    date: dateStr,
                    stats: stats
                });
            });
        });
        return payload;
    }

    function calculateStats(scores) {
        const n = scores.length;
        const sum = scores.reduce((a, b) => a + b, 0);
        const avg = (sum / n).toFixed(1);
        const max = scores[0];
        const min = scores[n - 1];
        
        // 簡單五標計算
        const p88 = scores[Math.floor(n * 0.12)];
        const p75 = scores[Math.floor(n * 0.25)];
        const p50 = scores[Math.floor(n * 0.50)];
        const p25 = scores[Math.floor(n * 0.75)];
        const p12 = scores[Math.floor(n * 0.88)];

        // 分佈統計
        let dist = { '100':0, '90-99':0, '80-89':0, '70-79':0, '60-69':0, 'below60':0 };
        scores.forEach(s => {
            if (s === 100) dist['100']++;
            else if (s >= 90) dist['90-99']++;
            else if (s >= 80) dist['80-89']++;
            else if (s >= 70) dist['70-79']++;
            else if (s >= 60) dist['60-69']++;
            else dist['below60']++;
        });

        return { avg, max, min, five: { top: p88, front: p75, avg: p50, back: p25, bottom: p12 }, dist };
    }

    // 模擬 Google Apps Script 環境
    const google = {
        script: {
            run: {
                withSuccessHandler: function(callback) {
                    return {
                        apiLogin: (seat, pwd) => {
                            setTimeout(() => {
                                // 1. 模擬檢查資料庫連線
                                const savedUrl = sessionStorage.getItem('DB_URL');
                                if (savedUrl !== "https://demo-db") {
                                    callback({ 
                                        success: false, 
                                        isSystemError: true, // 標記為系統級錯誤
                                        msg: "連線錯誤：無法存取目標資料庫" 
                                    });
                                    return;
                                }

                                // 2. 模擬檢查金鑰解密
                                const savedSalt = sessionStorage.getItem('SYSTEM_SALT');
                                if (savedSalt !== "demo-key") {
                                    callback({ 
                                        success: false, 
                                        isSystemError: true, // 標記為系統級錯誤
                                        msg: "解密失敗：金鑰錯誤，無法解析資料" 
                                    });
                                    return;
                                }

                                // 3. 驗證帳號密碼 (預設: 01 / 0000)
                                if (seat === "01" && pwd === "0000") {
                                    callback({
                                        success: true,
                                        name: "王小明",
                                        seat: "01",
                                        role: "student",
                                        time: new Date().toLocaleString(),
                                        payload: generateMockPayload()
                                    });
                                } else {
                                    callback({ success: false, msg: "座號或密碼錯誤 (預設: 01 / 0000)" });
                                }
                            }, 800);
                        },
                        apiChangePassword: (seat, oldPwd, newPwd) => {
                            setTimeout(() => {
                                if(oldPwd === "0000") callback({ success: true, msg: "密碼修改成功 (模擬)" });
                                else callback({ success: false, msg: "舊密碼錯誤" });
                            }, 600);
                        },
                        // ★★★ 新增：設定儲存與驗證 ★★★
                        apiSaveSettings: (url, salt) => {
                            setTimeout(() => {
                                // 模擬真實情況：系統會儲存設定，直到登入時嘗試連線才知道錯了
                                sessionStorage.setItem('DB_URL', url);
                                sessionStorage.setItem('SYSTEM_SALT', salt);
                                callback({ success: true }); 
                            }, 1000);
                        }
                    };
                }
            }
        }
    };
  </script>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col font-sans">

  <nav class="bg-white border-b border-slate-200 sticky top-0 z-40 shadow-sm">
    <div class="w-full max-w-[96%] mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center gap-3">
         <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-lg shadow-blue-200 shadow-lg">G</div>
         <h1 class="font-bold text-lg tracking-tight text-slate-700">Grade<span class="text-blue-600">Flow</span></h1>
      </div>
      
      <div id="user-info" class="hidden flex items-center gap-3 text-sm">
         <span class="hidden md:inline text-slate-500">Hi, <span id="display-name" class="font-bold text-slate-800"></span></span>
         <button onclick="logout()" class="text-slate-400 hover:text-red-500 hover:bg-red-50 px-3 py-1.5 rounded-md transition-colors font-bold flex items-center gap-1">
             <i class="fa-solid fa-right-from-bracket"></i> 登出
         </button>
      </div>
    </div>
  </nav>

  <main class="flex-1 flex flex-col items-center p-4 w-full max-w-[96%] mx-auto relative">
    
    <div id="login-card" class="w-full max-w-md bg-white p-8 rounded-2xl shadow-xl border border-slate-200 animate-fade-in mt-10 mx-auto">
      <div class="text-center mb-8">
          <div class="w-16 h-16 bg-gradient-to-tr from-blue-500 to-indigo-600 text-white rounded-2xl flex items-center justify-center text-3xl mx-auto mb-4 shadow-blue-200 shadow-xl transform rotate-3">
              <i class="fa-solid fa-graduation-cap"></i>
          </div>
          <h2 class="text-2xl font-bold text-slate-800">成績查詢登入</h2>
          <p class="text-slate-400 mt-2 text-sm">請輸入您的座號與專屬密碼</p>
      </div>
      
      <div class="bg-blue-50 text-blue-700 p-3 rounded-lg text-xs mb-6 text-center border border-blue-100">
          <i class="fa-solid fa-circle-info mr-1"></i> Demo 預設帳號：座號 <b>01</b> / 密碼 <b>0000</b>
      </div>

      <div class="space-y-4">
        <div class="relative">
            <i class="fa-solid fa-hashtag absolute left-4 top-4 text-slate-400"></i>
            <input id="inp-seat" type="number" value="01" class="w-full border border-slate-200 bg-slate-50 p-3 pl-10 rounded-lg text-lg font-bold outline-none focus:bg-white focus:ring-2 focus:ring-blue-500 transition-all" placeholder="座號">
        </div>
        
        <div class="relative">
            <i class="fa-solid fa-key absolute left-4 top-4 text-slate-400"></i>
            <input id="inp-pwd" type="password" value="0000" class="w-full border border-slate-200 bg-slate-50 p-3 pl-10 rounded-lg text-lg outline-none focus:bg-white focus:ring-2 focus:ring-blue-500 transition-all" placeholder="密碼">
        </div>

        <button onclick="doLogin()" id="btn-login" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg active:scale-95 transition-all text-lg mt-2">
            登 入
        </button>
      </div>
      
      <div id="msg-area" class="mt-4 text-center text-sm font-bold text-red-500 min-h-[20px]"></div>
    </div>
    <div id="setup-card" class="hidden w-full max-w-md bg-white p-8 rounded-2xl shadow-xl border border-slate-200 animate-fade-in mt-10 mx-auto relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 to-indigo-600"></div>
        
        <div class="text-center mb-8">
            <div class="w-16 h-16 bg-slate-100 text-slate-600 rounded-2xl flex items-center justify-center text-3xl mx-auto mb-4 shadow-sm">
                <i class="fa-solid fa-screwdriver-wrench"></i>
            </div>
            <h2 class="text-2xl font-bold text-slate-800">系統初始化</h2>
            <p class="text-slate-400 mt-2 text-sm">首次使用，請連結資料庫並設定金鑰</p>
        </div>

        <div class="bg-amber-50 border-l-4 border-amber-400 p-3 mb-6 rounded text-xs text-amber-800 relative group">
            <div class="font-bold mb-1"><i class="fa-solid fa-circle-info mr-1"></i> Demo 測試提示：</div>
            <p class="mb-1">請輸入以下正確數值以通過驗證：</p>
            <div class="font-mono bg-white/50 p-1 rounded mb-1 cursor-pointer hover:bg-white transition-colors" onclick="fillSetup('url')">
                URL: <span class="font-bold select-all">https://demo-db</span>
            </div>
            <div class="font-mono bg-white/50 p-1 rounded cursor-pointer hover:bg-white transition-colors" onclick="fillSetup('salt')">
                Salt: <span class="font-bold select-all">demo-key</span>
            </div>
            <div class="mt-2 text-[10px] opacity-60 text-right">(點擊上方數值可快速填入)</div>
        </div>

        <div class="space-y-5">
            <div>
                <label class="block text-xs font-bold text-slate-500 mb-1 ml-1">資料庫網址</label>
                <div class="relative">
                    <i class="fa-solid fa-link absolute left-3 top-3 text-slate-400"></i>
                    <input id="inp-setup-url" type="text" class="w-full border border-slate-300 bg-white p-2.5 pl-10 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-500 transition-all font-mono" placeholder="https://docs.google.com/...">
                </div>
            </div>
            
            <div>
                <label class="block text-xs font-bold text-slate-500 mb-1 ml-1">加密金鑰 (Salt)</label>
                <div class="relative">
                    <i class="fa-solid fa-key absolute left-3 top-3 text-slate-400"></i>
                    <input id="inp-setup-salt" type="password" class="w-full border border-slate-300 bg-white p-2.5 pl-10 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-500 transition-all font-mono" placeholder="輸入金鑰">
                </div>
            </div>

            <button onclick="doSetup()" id="btn-setup" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-lg shadow-lg active:scale-95 transition-all text-sm mt-2">
                連結並儲存設定
            </button>
        </div>
        
        <div id="setup-msg" class="mt-4 text-center text-sm font-bold text-red-500 min-h-[20px]"></div>
    </div>

    <div id="dashboard" class="hidden w-full space-y-6 animate-fade-in pb-20">
    
        <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-2xl p-6 text-white shadow-xl relative overflow-hidden">
             <div class="relative z-10 flex flex-col md:flex-row justify-between items-start md:items-end gap-4 mb-6 border-b border-white/10 pb-4">
                 <div>
                     <div class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-1">Student Profile</div>
                     <div class="flex items-center gap-3">
                        <h2 class="text-3xl font-black tracking-tight" id="dash-name">--</h2>
                        <span class="bg-blue-500 text-white px-2 py-0.5 rounded text-xs font-bold shadow">座號 <span id="dash-seat">--</span></span>
                     </div>
                     <div class="text-xs text-slate-400 mt-1">最後更新：<span id="dash-time" class="text-green-400 font-mono">--</span></div>
                 </div>
                 <div class="flex gap-2">
                     <button onclick="openPwdModal()" class="bg-white/10 hover:bg-white/20 text-white px-3 py-1.5 rounded-lg text-xs font-bold backdrop-blur-sm transition-colors border border-white/10 flex items-center">
                        <i class="fa-solid fa-lock mr-2"></i>修改密碼
                     </button>
                 </div>
             </div>
             <div class="relative z-10">
                 <h3 class="text-xs font-bold text-slate-400 uppercase mb-3 flex items-center">
                    <i class="fa-solid fa-calculator mr-2"></i>學期算術平均 (Arithmetic Mean)
                 </h3>
                 <div class="flex flex-wrap gap-3" id="global-stats-area"></div>
             </div>
        </div>
    
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <h3 class="font-bold text-slate-700 flex items-center">
                        <i class="fa-solid fa-chart-line mr-2 text-blue-500"></i>學習趨勢追蹤
                    </h3>
                    <p class="text-[10px] text-slate-400">觀察各科成績或排名的變動軌跡</p>
                </div>
                
                <div class="flex bg-slate-100 p-1 rounded-lg border border-slate-200">
                    <button onclick="toggleTrendType('score')" id="btn-trend-score" class="px-4 py-1.5 rounded-md text-sm font-bold transition-all bg-white text-blue-600 shadow-sm">
                        分數
                    </button>
                    <button onclick="toggleTrendType('rank')" id="btn-trend-rank" class="px-4 py-1.5 rounded-md text-sm font-bold transition-all text-slate-500 hover:text-slate-700">
                        排名
                    </button>
                </div>
            </div>
            <div class="p-6 relative">
                
                <div id="chart-legend-container" class="flex flex-wrap gap-2 mb-4 justify-center min-h-[30px]"></div>
    
                <div class="w-full overflow-x-auto custom-scrollbar pb-2">
                    <div id="chart-scroll-wrapper" class="h-64 min-w-full relative transition-all duration-300">
                        <canvas id="main-trend-chart"></canvas>
                    </div>
                </div>
    
                <div id="trend-empty" class="hidden absolute inset-0 bg-white/80 flex items-center justify-center text-slate-400 text-sm">
                    請選擇特定科目以查看詳細趨勢
                </div>
            </div>
        </div>
    
        <div class="flex flex-col md:flex-row gap-4 bg-white p-3 rounded-xl shadow-sm border border-slate-200 items-center justify-between sticky top-[72px] z-30">
            <div class="flex items-center gap-3 w-full md:w-auto">
                <div class="relative flex-1 md:w-64">
                    <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <input id="filter-search" oninput="applyFilters()" type="text" placeholder="搜尋作業..." class="w-full bg-slate-50 border border-slate-200 rounded-lg pl-10 pr-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <select id="filter-subject" onchange="applyFilters()" class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500 font-bold text-slate-600 max-w-[120px]">
                    <option value="all">全科目</option>
                </select>
            </div>
            
            <div class="flex items-center gap-2 w-full md:w-auto justify-end">
                <select id="sort-mode" onchange="applyFilters()" class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none font-bold text-slate-600">
                    <option value="date-desc">新→舊</option>
                    <option value="score-desc">高→低</option>
                    <option value="score-asc">低→高</option>
                </select>
    
                <div class="flex bg-slate-100 p-1 rounded-lg border border-slate-200">
                    <button onclick="switchViewType('grid')" id="btn-view-grid" class="px-3 py-1.5 rounded-md text-blue-600 bg-white shadow-sm text-sm transition-all"><i class="fa-solid fa-grip"></i></button>
                    <button onclick="switchViewType('table')" id="btn-view-table" class="px-3 py-1.5 rounded-md text-slate-400 hover:text-slate-600 text-sm transition-all"><i class="fa-solid fa-list"></i></button>
                </div>
            </div>
        </div>
    
        <div id="content-area">
            <div id="view-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 2xl:grid-cols-4 gap-5"></div>
            <div id="view-table" class="hidden bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-500 font-bold border-b border-slate-200 uppercase tracking-wider">
                            <tr>
                                <th class="p-4 w-1/4">科目 / 作業</th>
                                <th class="p-4 w-32">日期</th>
                                <th class="p-4 w-24 text-center">排名</th>
                                <th class="p-4 w-24 text-center">分數</th>
                                <th class="p-4 w-24 text-center">操作</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="empty-state" class="hidden text-center py-20 text-slate-400">
            <i class="fa-solid fa-folder-open text-6xl mb-4 text-slate-200"></i>
            <p>無符合資料</p>
        </div>
    </div>
    
  </main>

  <footer class="text-center py-6 text-slate-300 text-xs mt-auto">GradeFlow System &copy; 2026</footer>
  <div id="debug-controls" class="fixed bottom-4 right-4 z-50">
      <button onclick="resetSystem()" class="bg-red-100 hover:bg-red-200 text-red-600 border border-red-200 px-3 py-1.5 rounded-full text-xs font-bold shadow-sm transition-all flex items-center opacity-50 hover:opacity-100" title="清除所有設定回到初始狀態">
          <i class="fa-solid fa-rotate-right mr-1.5"></i> 重置系統 (Reset)
      </button>
  </div>

  <div id="analysis-modal" class="fixed inset-0 bg-slate-900/50 hidden flex items-center justify-center p-4 backdrop-blur-sm z-50">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden animate-fade-in flex flex-col max-h-[90vh]">
      <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-5 py-3 flex justify-between items-center flex-shrink-0">
        <h3 class="font-bold text-lg"><i class="fa-solid fa-chart-pie mr-2"></i>成績落點分析</h3>
        <button onclick="document.getElementById('analysis-modal').classList.add('hidden')" class="hover:text-indigo-200"><i class="fa-solid fa-xmark text-xl"></i></button>
      </div>
      <div class="p-6 overflow-y-auto">
          <div class="mb-4 pb-4 border-b border-slate-100">
              <h4 class="font-bold text-slate-800 text-lg mb-1" id="an-task">--</h4>
              <div class="text-xs text-slate-500" id="an-sub">--</div>
          </div>
          <div class="grid grid-cols-3 gap-3 mb-6 text-center">
              <div class="bg-slate-50 p-2 rounded"><div class="text-xs text-slate-400">全班平均</div><div class="font-bold text-lg text-blue-600" id="an-avg">--</div></div>
              <div class="bg-slate-50 p-2 rounded"><div class="text-xs text-slate-400">最高分</div><div class="font-bold text-lg text-green-600" id="an-max">--</div></div>
              <div class="bg-slate-50 p-2 rounded"><div class="text-xs text-slate-400">最低分</div><div class="font-bold text-lg text-red-600" id="an-min">--</div></div>
          </div>
          
          <div class="grid grid-cols-5 gap-1 mb-6 text-center">
             <div class="val-bottom p-2 rounded border border-red-100"><div class="text-[10px] opacity-70">底</div><div class="font-bold text-sm" id="an-p12">--</div></div>
             <div class="val-back p-2 rounded border border-orange-100"><div class="text-[10px] opacity-70">後</div><div class="font-bold text-sm" id="an-p25">--</div></div>
             <div class="val-avg p-2 rounded border border-emerald-100"><div class="text-[10px] opacity-70">均</div><div class="font-bold text-sm" id="an-p50">--</div></div>
             <div class="val-front p-2 rounded border border-blue-100"><div class="text-[10px] opacity-70">前</div><div class="font-bold text-sm" id="an-p75">--</div></div>
             <div class="val-top p-2 rounded border border-purple-100"><div class="text-[10px] opacity-70">頂</div><div class="font-bold text-sm" id="an-p88">--</div></div>
          </div>

          <div class="h-48 w-full relative"><canvas id="an-chart"></canvas></div>
      </div>
    </div>
  </div>

  <div id="pwd-modal" class="fixed inset-0 bg-slate-900/50 hidden flex items-center justify-center p-4 backdrop-blur-sm z-50">
    <div class="bg-white p-6 rounded-xl w-full max-w-sm shadow-2xl animate-fade-in">
        <h3 class="font-bold text-lg mb-4 text-slate-700">修改密碼</h3>
        <input id="new-pwd" type="text" class="w-full border p-2.5 rounded-lg mb-4 outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50" placeholder="請輸入新密碼">
        <div class="flex gap-2 justify-end">
            <button onclick="document.getElementById('pwd-modal').classList.add('hidden')" class="px-4 py-2 text-slate-500 hover:bg-slate-50 rounded-lg transition-colors font-bold text-sm">取消</button>
            <button onclick="doChangePwd()" id="btn-chg-pwd" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors text-sm">確認修改</button>
        </div>
    </div>
  </div>

  <script>
    /**
     * JS Logic
     */
    let currentUser = { seat: '', pwd: '' };
    let cachedPayload = [];
    let currentViewData = [];
    let currentChart = null; 
    let trendChartInstance = null;
    let currentTrendType = 'score';

    // 顏色定義
    const KEYWORD_COLORS = [
        { regex: /[國语语]/, color: '#ef4444' }, // 紅
        { regex: /[英外]/,   color: '#3b82f6' }, // 藍
        { regex: /[數算]/,   color: '#10b981' }, // 綠
        { regex: /[社史地公]/, color: '#f59e0b' }, // 橘
        { regex: /[自理化生]/, color: '#8b5cf6' }, // 紫
    ];
    const PALETTE = ['#06b6d4', '#ec4899', '#84cc16', '#6366f1', '#14b8a6', '#f43f5e', '#78350f'];
    let subjectColorMap = {};

    function doLogin() {
      const seat = document.getElementById('inp-seat').value.trim();
      const pwd = document.getElementById('inp-pwd').value.trim();

      if(!seat || !pwd) {
        showMsg("請輸入完整資訊");
        return;
      }

      const btn = document.getElementById('btn-login'); 
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>'; 
      btn.disabled = true;
      showMsg(""); // 清空訊息
      
      google.script.run.withSuccessHandler(res => {
        btn.innerHTML = '登 入'; btn.disabled = false;
        
        if(res.success) {
          currentUser = { seat: seat, pwd: pwd };
          cachedPayload = res.payload || [];
          initDashboard(res);
        } else {
          // 判斷是否為系統設定錯誤
          if (res.isSystemError) {
              const errorHtml = `
                  <div class="flex flex-col items-center animate-shake">
                      <div class="text-red-500 font-bold mb-1"><i class="fa-solid fa-circle-xmark mr-1"></i>${res.msg}</div>
                      <div class="text-xs text-slate-400 mb-2">剛才輸入的設定有誤，請重置後再試</div>
                      <button onclick="resetSystem()" class="bg-red-50 text-red-600 border border-red-200 px-4 py-1.5 rounded-full text-xs font-bold hover:bg-red-100 transition-colors">
                          <i class="fa-solid fa-rotate-right mr-1"></i> 立即重置系統設定
                      </button>
                  </div>
              `;
              document.getElementById('msg-area').innerHTML = errorHtml;
          } else {
              // 一般帳密錯誤
              showMsg(res.msg);
          }
        }
      }).apiLogin(seat, pwd);
    }

    function logout() { 
        location.reload(); 
    }

    function showMsg(txt) {
        document.getElementById('msg-area').innerText = txt;
    }

    // --- 新增：系統設定邏輯 ---

    function doSetup() {
        const url = document.getElementById('inp-setup-url').value.trim();
        const salt = document.getElementById('inp-setup-salt').value.trim();
        const msg = document.getElementById('setup-msg');
        const btn = document.getElementById('btn-setup');

        if(!url || !salt) {
            msg.innerText = "請輸入完整資訊";
            return;
        }

        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin mr-2"></i>儲存設定中...';
        btn.disabled = true;
        msg.innerText = "";

        google.script.run.withSuccessHandler(res => {
            // 無論輸入什麼，都視為格式正確並儲存
            // 真正的連線測試留到登入時進行
            btn.innerHTML = '<i class="fa-solid fa-check mr-2"></i>設定已儲存';
            btn.classList.replace('bg-slate-800', 'bg-green-600');
            
            // 寫入初始化標記
            sessionStorage.setItem('SYS_INIT', 'true');
            
            // 1秒後跳轉至登入頁
            setTimeout(() => {
                checkSystemInit();
                // 復原按鈕狀態
                btn.innerHTML = '連結並儲存設定';
                btn.classList.replace('bg-green-600', 'bg-slate-800');
                btn.disabled = false;
            }, 800);
        }).apiSaveSettings(url, salt);
    }

    function resetSystem() {
        if(!confirm("確定要重置系統嗎？\n\n這將清除所有登入狀態與設定，回到初始化畫面。")) return;
        
        sessionStorage.clear();
        localStorage.removeItem('s_portal_seat');
        localStorage.removeItem('s_portal_pwd');
        
        location.reload();
    }

    // 輔助：快速填入 Demo 值
    function fillSetup(type) {
        if(type === 'url') document.getElementById('inp-setup-url').value = "https://demo-db";
        if(type === 'salt') document.getElementById('inp-setup-salt').value = "demo-key";
    }

    function initDashboard(data) {
        document.getElementById('login-card').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');
        document.getElementById('dash-name').innerText = data.name;
        document.getElementById('dash-seat').innerText = data.seat;
        document.getElementById('dash-time').innerText = data.time || "剛剛";
        
        document.getElementById('user-info').classList.remove('hidden');
        document.getElementById('display-name').innerText = data.name;

        const subjects = [...new Set(cachedPayload.map(i => i.subject))];
        const subSelect = document.getElementById('filter-subject');
        subSelect.innerHTML = '<option value="all">全科目</option>';
        subjects.forEach(s => subSelect.innerHTML += `<option value="${s}">${s}</option>`);

        calcGlobalStats();
        applyFilters();
    }

    function formatNum(val) { 
        if (typeof val === 'number') { 
            return Number.isInteger(val) ? val : val.toFixed(2); 
        } 
        return val; 
    }

    function getSubjectColor(subName) {
        if (subjectColorMap[subName]) return subjectColorMap[subName];
        for (let entry of KEYWORD_COLORS) {
            if (entry.regex.test(subName)) {
                subjectColorMap[subName] = entry.color;
                return entry.color;
            }
        }
        const index = Object.keys(subjectColorMap).length % PALETTE.length;
        const assignedColor = PALETTE[index];
        subjectColorMap[subName] = assignedColor;
        return assignedColor;
    }

    function toggleTrendType(type) {
        currentTrendType = type;
        const btnScore = document.getElementById('btn-trend-score');
        const btnRank = document.getElementById('btn-trend-rank');
        const isScore = type === 'score';

        btnScore.className = isScore ? "px-4 py-1.5 rounded-md text-sm font-bold transition-all bg-white text-blue-600 shadow-sm" : "px-4 py-1.5 rounded-md text-sm font-bold transition-all text-slate-500 hover:text-slate-700";
        btnRank.className = !isScore ? "px-4 py-1.5 rounded-md text-sm font-bold transition-all bg-white text-blue-600 shadow-sm" : "px-4 py-1.5 rounded-md text-sm font-bold transition-all text-slate-500 hover:text-slate-700";
        
        renderTrendChart();
    }

    function renderTrendChart() {
        const subjectFilter = document.getElementById('filter-subject').value;
        const canvas = document.getElementById('main-trend-chart');
        const scrollWrapper = document.getElementById('chart-scroll-wrapper');
        const isRank = currentTrendType === 'rank';

        let baseData = [...currentViewData].sort((a, b) => {
            const dateA = a.date || "00/00";
            const dateB = b.date || "00/00";
            if (dateA !== dateB) return dateA.localeCompare(dateB);
            return a.task.localeCompare(b.task);
        });

        if (baseData.length < 2) {
            document.getElementById('trend-empty').classList.remove('hidden');
            if(trendChartInstance) trendChartInstance.destroy();
            document.getElementById('chart-legend-container').innerHTML = "";
            return;
        } else {
            document.getElementById('trend-empty').classList.add('hidden');
        }

        const labels = baseData.map(d => `${d.date}\n${d.task}`);
        const minPointWidth = 60;
        const requiredWidth = labels.length * minPointWidth;
        const containerWidth = canvas.parentElement.parentElement.clientWidth; 
        scrollWrapper.style.width = `${Math.max(requiredWidth, containerWidth)}px`;

        let datasets = [];
        const subjects = (subjectFilter === 'all') ? [...new Set(baseData.map(d => d.subject))] : [subjectFilter];
        
        subjects.forEach(sub => {
            const color = getSubjectColor(sub);
            const dataPoints = baseData.map(d => {
                return (d.subject === sub) ? (isRank ? d.rank : d.score) : null;
            });

            datasets.push({
                label: sub,
                data: dataPoints,
                borderColor: color,
                backgroundColor: color,
                borderWidth: 3,
                tension: 0.1,
                pointRadius: 5,
                pointHoverRadius: 7,
                spanGaps: true
            });
        });

        if(trendChartInstance) trendChartInstance.destroy();

        const ctx = canvas.getContext('2d');
        trendChartInstance = new Chart(ctx, {
            type: 'line',
            data: { 
                labels: baseData.map(d => d.date || "-"),
                datasets: datasets 
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            title: function(tooltipItems) {
                                const index = tooltipItems[0].dataIndex;
                                const item = baseData[index];
                                return `${item.date} - ${item.task}`;
                            },
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                label += isRank ? `第 ${context.parsed.y} 名` : `${context.parsed.y} 分`;
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        reverse: isRank,
                        beginAtZero: !isRank,
                        max: isRank ? undefined : 100,
                        grid: { borderDash: [2, 2], color: '#f1f5f9' }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { autoSkip: false, maxRotation: 0 }
                    }
                }
            }
        });

        generateCustomLegend(trendChartInstance);
    }

    function generateCustomLegend(chart) {
        const container = document.getElementById('chart-legend-container');
        container.innerHTML = "";

        chart.data.datasets.forEach((dataset, index) => {
            const btn = document.createElement('button');
            const isHidden = !chart.isDatasetVisible(index);
            btn.className = `flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-bold border transition-all ${isHidden ? 'bg-slate-50 text-slate-400 border-slate-200' : 'bg-white text-slate-700 border-slate-200 shadow-sm'}`;
            
            const dot = document.createElement('span');
            dot.className = "w-3 h-3 rounded-full";
            dot.style.backgroundColor = isHidden ? '#cbd5e1' : dataset.backgroundColor;
            
            const text = document.createElement('span');
            text.innerText = dataset.label;
            if(isHidden) text.style.textDecoration = "line-through";

            btn.appendChild(dot);
            btn.appendChild(text);

            btn.onclick = () => {
                chart.setDatasetVisibility(index, !chart.isDatasetVisible(index));
                chart.update();
                generateCustomLegend(chart); 
            };
            container.appendChild(btn);
        });
    }
    
    function applyFilters() {
        const search = document.getElementById('filter-search').value.toLowerCase();
        const subject = document.getElementById('filter-subject').value;
        const sortMode = document.getElementById('sort-mode').value;

        currentViewData = cachedPayload.filter(item => {
            return ((item.task||"").toLowerCase().includes(search) || (item.subject||"").toLowerCase().includes(search)) &&
                   ((subject === 'all') || (item.subject === subject));
        });

        currentViewData.sort((a, b) => {
            if(sortMode === 'date-desc') return (b.date||"").localeCompare(a.date||"");
            if(sortMode === 'score-desc') return b.score - a.score;
            if(sortMode === 'score-asc') return a.score - b.score;
            return 0;
        });

        const grid = document.getElementById('view-grid');
        grid.innerHTML = "";
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = "";
        
        if(currentViewData.length === 0) {
            document.getElementById('empty-state').classList.remove('hidden');
        } else {
            document.getElementById('empty-state').classList.add('hidden');
            currentViewData.forEach((r, idx) => {
                grid.appendChild(createScoreCard(r, idx));
                tbody.appendChild(createTableRow(r, idx));
            });
        }

        renderTrendChart(); 
    }

    function calcGlobalStats() {
        const area = document.getElementById('global-stats-area');
        area.innerHTML = "";
        const totalSum = cachedPayload.reduce((a, b) => a + b.score, 0);
        const totalAvg = cachedPayload.length ? (totalSum / cachedPayload.length).toFixed(1) : "0.0";
        
        const subjects = {};
        cachedPayload.forEach(r => {
            if(!subjects[r.subject]) subjects[r.subject] = { sum: 0, count: 0 };
            subjects[r.subject].sum += r.score;
            subjects[r.subject].count++;
        });

        area.innerHTML += `
            <div class="bg-white/10 backdrop-blur-sm border border-white/20 rounded-lg px-4 py-2 flex flex-col justify-center min-w-[100px]">
                <div class="text-[10px] text-slate-300 font-bold uppercase">總平均</div>
                <div class="text-2xl font-black text-white">${totalAvg}</div>
            </div>
        `;

        Object.keys(subjects).forEach(sub => {
            const avg = (subjects[sub].sum / subjects[sub].count).toFixed(1);
            area.innerHTML += `
                <div class="bg-white/5 border border-white/10 rounded-lg px-3 py-2 flex flex-col justify-center min-w-[80px]">
                    <div class="text-[10px] text-slate-400 font-bold uppercase truncate max-w-[80px]">${sub}</div>
                    <div class="text-lg font-bold text-slate-200">${avg}</div>
                </div>
            `;
        });
    }

    function switchViewType(mode) {
        if(mode === 'grid') {
            document.getElementById('view-grid').classList.remove('hidden');
            document.getElementById('view-table').classList.add('hidden');
            document.getElementById('btn-view-grid').className = "px-3 py-1.5 rounded-md text-blue-600 bg-white shadow-sm text-sm transition-all";
            document.getElementById('btn-view-table').className = "px-3 py-1.5 rounded-md text-slate-400 hover:text-slate-600 text-sm transition-all";
        } else {
            document.getElementById('view-grid').classList.add('hidden');
            document.getElementById('view-table').classList.remove('hidden');
            document.getElementById('btn-view-table').className = "px-3 py-1.5 rounded-md text-blue-600 bg-white shadow-sm text-sm transition-all";
            document.getElementById('btn-view-grid').className = "px-3 py-1.5 rounded-md text-slate-400 hover:text-slate-600 text-sm transition-all";
        }
    }

    function createScoreCard(r, index) {
        const el = document.createElement('div');
        el.className = "bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden hover:shadow-lg transition-all duration-300 group cursor-pointer relative";
        el.onclick = function() { openAnalysisModalByIndex(index); };

        let scoreClass = r.score >= 90 ? "text-emerald-600 bg-emerald-50" : (r.score < 60 ? "text-red-500 bg-red-50" : "text-slate-700 bg-slate-100");
        let rankBadge = r.rank <= 3 ? `<i class="fa-solid fa-crown text-amber-400 ml-1"></i>` : "";

        let fiveHtml = "";
        let distHtml = "";
        
        if(r.stats && r.stats.five) {
            const f = r.stats.five; 
            const blocks = [
                { label: '底', val: f.bottom, cls: 'val-bottom' },
                { label: '後', val: f.back,   cls: 'val-back' },
                { label: '均', val: f.avg,    cls: 'val-avg' },
                { label: '前', val: f.front,  cls: 'val-front' },
                { label: '頂', val: f.top,    cls: 'val-top' }
            ];

            const blockHtml = blocks.map(b => `
                <div class="${b.cls} border rounded p-1 flex flex-col items-center justify-center min-h-[44px]">
                    <span class="text-[9px] font-bold opacity-70 uppercase tracking-tighter leading-none mb-0.5">${b.label}</span>
                    <span class="text-sm font-black leading-none">${formatNum(b.val)}</span>
                </div>
            `).join('');

            fiveHtml = `<div class="mt-4 pt-3 border-t border-slate-100"><div class="grid grid-cols-5 gap-1.5 text-center">${blockHtml}</div></div>`;

            const chartId = `chart-${Math.random().toString(36).substr(2, 9)}`;
            distHtml = `<div class="mt-3 px-1 pointer-events-none"><div class="h-12 w-full relative"><canvas id="${chartId}"></canvas></div></div>`;
            setTimeout(() => renderMiniChart(chartId, r.stats.dist, r.score), 100);
        }

        el.innerHTML = `
            <div class="p-5 pointer-events-none">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <span class="bg-slate-100 text-slate-500 text-[10px] px-2 py-1 rounded-full font-bold uppercase tracking-wider border border-slate-200">${r.subject}</span>
                        <h3 class="font-bold text-lg text-slate-700 leading-tight mt-2">${r.task}</h3>
                        <div class="text-xs text-slate-400 mt-1 flex items-center">
                            <i class="fa-regular fa-calendar mr-1"></i>${r.date || '-'}
                            <span class="mx-2 text-slate-200">|</span>
                            <span class="font-mono">#${r.rank}</span> 名 ${rankBadge}
                        </div>
                    </div>
                    <div class="${scoreClass} w-16 h-16 rounded-2xl flex flex-col items-center justify-center shadow-inner border border-black/5">
                         <span class="text-2xl font-black">${formatNum(r.score)}</span>
                         <span class="text-[10px] font-bold opacity-60">SCORE</span>
                    </div>
                </div>
                ${fiveHtml}
                ${distHtml}
            </div>
        `;
        return el;
    }

    function createTableRow(r, index) {
        const tr = document.createElement('tr');
        tr.className = "hover:bg-slate-50 transition-colors border-b border-slate-50 last:border-0 cursor-pointer";
        tr.onclick = function() { openAnalysisModalByIndex(index); };
        let scoreClass = r.score < 60 ? "text-red-500 font-bold" : "text-slate-700 font-bold";
        tr.innerHTML = `
            <td class="p-4">
                <div class="font-bold text-slate-700">${r.task}</div>
                <div class="text-xs text-slate-400 mt-0.5"><span class="bg-slate-100 px-1.5 rounded mr-1">${r.subject}</span> ${r.sheet}</div>
            </td>
            <td class="p-4 text-slate-500 text-xs font-mono">${r.date || '-'}</td>
            <td class="p-4 text-center text-slate-600 font-mono">#${r.rank}</td>
            <td class="p-4 text-center ${scoreClass} text-lg">${formatNum(r.score)}</td>
            <td class="p-4 text-center">
                <button class="text-blue-500 hover:text-blue-700 bg-blue-50 hover:bg-blue-100 p-2 rounded-full transition-colors"><i class="fa-solid fa-chart-simple"></i></button>
            </td>
        `;
        return tr;
    }

    function openAnalysisModalByIndex(index) {
        const item = currentViewData[index];
        if(!item) return;

        document.getElementById('analysis-modal').classList.remove('hidden');
        document.getElementById('an-task').innerText = item.task;
        document.getElementById('an-sub').innerText = `${item.subject} / ${item.sheet}`;
        document.getElementById('an-avg').innerText = formatNum(item.stats.avg);
        document.getElementById('an-max').innerText = formatNum(item.stats.max);
        document.getElementById('an-min').innerText = formatNum(item.stats.min);
        
        document.getElementById('an-p12').innerText = formatNum(item.stats.five.bottom);
        document.getElementById('an-p25').innerText = formatNum(item.stats.five.back);
        document.getElementById('an-p50').innerText = formatNum(item.stats.five.avg);
        document.getElementById('an-p75').innerText = formatNum(item.stats.five.front);
        document.getElementById('an-p88').innerText = formatNum(item.stats.five.top);

        const myScore = Number(item.score);
        const ctx = document.getElementById('an-chart').getContext('2d');
        if(currentChart) currentChart.destroy();
        
        const labels = ['<60', '60-69', '70-79', '80-89', '90-99', '100'];
        const data = [item.stats.dist['below60'], item.stats.dist['60-69'], item.stats.dist['70-79'], item.stats.dist['80-89'], item.stats.dist['90-99'], item.stats.dist['100']];
        
        const bgColors = data.map((v, i) => {
           if(i===0 && myScore < 60) return '#f87171';
           if(i===1 && myScore >= 60 && myScore < 70) return '#fb923c';
           if(i===2 && myScore >= 70 && myScore < 80) return '#34d399';
           if(i===3 && myScore >= 80 && myScore < 90) return '#60a5fa';
           if(i===4 && myScore >= 90 && myScore < 100) return '#a78bfa';
           if(i===5 && myScore === 100) return '#7c3aed';
           return '#e2e8f0';
        });

        currentChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: labels, datasets: [{ data: data, backgroundColor: bgColors, borderRadius: 4 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false, beginAtZero: true }, x: { grid: { display: false }, ticks: { font: { size: 10 } } } } }
        });
    }

    function renderMiniChart(id, dist, myScore) {
       const ctx = document.getElementById(id).getContext('2d');
       const data = [dist['below60'], dist['60-69'], dist['70-79'], dist['80-89'], dist['90-99'], dist['100']];
       const colors = data.map((v, i) => {
           if(i===0 && myScore < 60) return '#f87171';
           if(i===1 && myScore >= 60 && myScore < 70) return '#fb923c';
           if(i===2 && myScore >= 70 && myScore < 80) return '#34d399';
           if(i===3 && myScore >= 80 && myScore < 90) return '#60a5fa';
           if(i===4 && myScore >= 90 && myScore < 100) return '#a78bfa';
           if(i===5 && myScore === 100) return '#7c3aed';
           return '#cbd5e1'; 
       });
       new Chart(ctx, {
           type: 'bar',
           data: { labels: ['','','','','',''], datasets: [{ data: data, backgroundColor: colors, borderRadius: 2 }] },
           options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false } }, scales: { y: { display: false }, x: { display: false } } }
       });
    }

    function openPwdModal() { document.getElementById('pwd-modal').classList.remove('hidden'); document.getElementById('new-pwd').value = ""; }
    function doChangePwd() {
        const newPwd = document.getElementById('new-pwd').value.trim();
        if(!newPwd) return alert("請輸入新密碼");
        const btn = document.getElementById('btn-chg-pwd'); btn.innerText = "處理中..."; btn.disabled = true;
        google.script.run.withSuccessHandler(res => {
            btn.innerText = "確認修改"; btn.disabled = false;
            if(res.success) { alert("修改成功！請重新登入"); logout(); }
            else { alert(res.msg); }
        }).apiChangePassword(currentUser.seat, currentUser.pwd, newPwd);
    }
  </script>
</body>
</html>