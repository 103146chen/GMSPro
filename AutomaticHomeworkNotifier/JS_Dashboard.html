<script>
  // æ¸²æŸ“å¡ç‰‡é¸å–® (v8.1 å°å¸«æ¨¡å¼å‡ç´š)
  function renderDashboardPicker() {
    const grid = document.getElementById('dash-class-grid');
    const noData = document.getElementById('dash-no-data');
    const title = document.getElementById('picker-title');
    const desc = document.getElementById('picker-desc');

    // æ ¹æ“šæ¨¡å¼èª¿æ•´æ¨™é¡Œ
    if(appData.mode === 'homeroom') {
        title.innerText = "å°å¸«ç­ç´šç®¡ç†";
        desc.innerText = "æŸ¥çœ‹å…¨ç­ç¸½è¡¨æˆ–é»æ“Šå–®ç§‘é€²è¡Œç®¡ç†";
    } else {
        title.innerText = "è«‹é¸æ“‡è¦ç®¡ç†çš„ç­ç´š";
        desc.innerText = "é»æ“Šå¡ç‰‡é€²å…¥ç®¡ç†ä»‹é¢";
    }

    if(!appData.classes || appData.classes.length === 0) { 
        grid.innerHTML = ""; 
        noData.classList.remove('hidden'); 
        return; 
    }
    
    noData.classList.add('hidden');
    let html = "";

    // â˜…â˜…â˜… v8.1: å°å¸«æ¨¡å¼æ’å…¥ã€Œå…¨ç­ç¸½è¡¨ã€å¡ç‰‡ â˜…â˜…â˜…
    if(appData.mode === 'homeroom') {
        html += `
        <button onclick="openMasterSheet()" class="col-span-full md:col-span-2 bg-gradient-to-r from-pink-600 to-purple-600 p-6 rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all text-left group relative overflow-hidden">
            <div class="absolute top-0 right-0 p-4 opacity-20 text-white"><i class="fa-solid fa-table-cells text-8xl"></i></div>
            <div class="flex items-center gap-4 relative z-10">
                <div class="w-16 h-16 rounded-full bg-white/20 text-white flex items-center justify-center text-3xl font-bold backdrop-blur-sm">
                    <i class="fa-solid fa-crown"></i>
                </div>
                <div>
                    <h4 class="font-bold text-2xl text-white mb-1">å…¨ç­æˆç¸¾ç¸½è¡¨</h4>
                    <p class="text-pink-100 text-sm">å½™æ•´æ‰€æœ‰é€£çµç§‘ç›®çš„æˆç¸¾è³‡æ–™</p>
                </div>
            </div>
        </button>
        `;
    }

    // æ¸²æŸ“ä¸€èˆ¬ç­ç´š/ç§‘ç›®å¡ç‰‡
    html += appData.classes.map((c, idx) => `
      <button onclick="selectClassFromDashboard(${idx})" class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:border-blue-400 hover:shadow-md hover:-translate-y-1 transition-all text-left group">
        <div class="flex justify-between items-start mb-3">
           <div class="w-12 h-12 rounded-full ${appData.mode==='homeroom'?'bg-purple-100 text-purple-600 group-hover:bg-purple-600':'bg-blue-100 text-blue-600 group-hover:bg-blue-600'} flex items-center justify-center text-xl font-bold group-hover:text-white transition-colors">
              ${escapeHtml(c.name).substring(0,1)}
           </div>
           <i class="fa-solid fa-chevron-right text-slate-300 ${appData.mode==='homeroom'?'group-hover:text-purple-500':'group-hover:text-blue-500'}"></i>
        </div>
        <h4 class="font-bold text-lg text-slate-700 mb-1">${escapeHtml(c.name)}</h4>
        <div class="text-xs text-slate-400 truncate">ç›£æ§: ${c.targets ? c.targets.length : 0} å€‹åˆ†é </div>
      </button>`).join('');

    grid.innerHTML = html;
  }

  // é€²å…¥å–®ä¸€ç­ç´š/ç§‘ç›®ç®¡ç†ä»‹é¢
  function selectClassFromDashboard(index) {
    appData.currentClass = appData.classes[index];
    
    document.getElementById('dash-picker').classList.add('hidden');
    document.getElementById('dash-content').classList.remove('hidden');
    
    // è¨­å®šæ¨™é¡Œ (æ ¹æ“šæ¨¡å¼èª¿æ•´ Badge)
    document.getElementById('dash-title-class').innerText = appData.currentClass.name;
    const badge = document.getElementById('dash-badge-class');
    if(appData.mode === 'homeroom') {
        badge.innerText = "Subject";
        badge.className = "bg-purple-100 text-purple-600 text-sm px-2 py-1 rounded mr-3 align-middle";
    } else {
        badge.innerText = "Class";
        badge.className = "bg-blue-100 text-blue-600 text-sm px-2 py-1 rounded mr-3 align-middle";
    }

    // å¡«å…¥è³‡æ–™
    const targets = appData.currentClass.targets || [];
    document.getElementById('dash-targets').innerText = targets.join(", ") || "ç„¡è¨­å®š";
    document.getElementById('dash-days').innerText = appData.currentClass.days;
    
    switchDashTab('missing');
  }

  // â˜…â˜…â˜… v8.1: é–‹å•Ÿå…¨ç­ç¸½è¡¨ â˜…â˜…â˜…
  function openMasterSheet() {
      document.getElementById('dash-picker').classList.add('hidden');
      document.getElementById('dash-content-master').classList.remove('hidden');
      
      // æ›´æ–°çµ±è¨ˆæ•¸å­—
      document.getElementById('master-subject-count').innerText = appData.classes.length;
  }

  // è¿”å›ç¸½è¦½ (v8.1 æ›´æ–°ï¼šåŒæ™‚éš±è— master è¦–åœ–)
  function showDashboardPicker() {
    document.getElementById('dash-content').classList.add('hidden');
    document.getElementById('dash-content-master').classList.add('hidden'); // æ–°å¢é€™è¡Œ
    document.getElementById('dash-picker').classList.remove('hidden');
    
    appData.currentClass = null;
    document.getElementById('dash-title-class').innerText = "";
    document.getElementById('dash-targets').innerText = "--";
    document.getElementById('dash-days').innerText = "--";
    
    // é‡ç½®æˆç¸¾å–® Tab ç‹€æ…‹
    document.getElementById('rpt-sheet-list').innerHTML = '<div class="text-xs text-slate-400 text-center mt-10">è¼‰å…¥ä¸­...</div>';
    document.getElementById('column-list').innerHTML = "";
    document.getElementById('simple-preview').innerHTML = '<div class="text-slate-300 text-center mt-20">é è¦½å…§å®¹å°‡é¡¯ç¤ºæ–¼æ­¤</div>';
    document.getElementById('col-mask').classList.remove('hidden');
    
    if(typeof reportRawData !== 'undefined') reportRawData = { full: [], headers: [], selectedCols: [] };
  }

  // Tab åˆ‡æ›é‚è¼¯ (ç¶­æŒä¸è®Š)
  function switchDashTab(tabName) {
    const btnMissing = document.getElementById('tab-btn-missing');
    const btnReport = document.getElementById('tab-btn-report');
    const divMissing = document.getElementById('dash-tab-missing');
    const divReport = document.getElementById('dash-tab-report');

    if (tabName === 'missing') {
       btnMissing.className = "flex-1 py-4 text-center font-bold text-amber-600 border-b-4 border-amber-500 bg-amber-50 transition-all";
       btnReport.className = "flex-1 py-4 text-center font-bold text-slate-400 border-b-2 border-transparent hover:text-blue-500 transition-all";
       divMissing.classList.remove('hidden');
       divReport.classList.add('hidden');
    } else {
       btnMissing.className = "flex-1 py-4 text-center font-bold text-slate-400 border-b-2 border-transparent hover:text-amber-500 transition-all";
       btnReport.className = "flex-1 py-4 text-center font-bold text-blue-600 border-b-4 border-blue-500 bg-blue-50 transition-all";
       divMissing.classList.add('hidden');
       divReport.classList.remove('hidden');
       loadReportTab();
    }
  }

  // è¼‰å…¥æˆç¸¾å–®åˆ†é åˆ—è¡¨ (ç¶­æŒä¸è®Š)
  function loadReportTab() {
     const listArea = document.getElementById('rpt-sheet-list');
     // å¦‚æœå·²ç¶“æœ‰å…§å®¹ä¸”ä¸æ˜¯ Loading ç‹€æ…‹ï¼Œå°±ä¸é‡è¤‡è¼‰å…¥
     if(listArea.children.length > 1 && !listArea.innerHTML.includes("loader")) return;
     
     listArea.innerHTML = '<div class="flex justify-center py-4"><div class="loader"></div></div>';
     
     google.script.run.withSuccessHandler(sheets => { 
        if(!sheets || sheets.length === 0) { 
            // â˜…â˜…â˜… å„ªåŒ–ç©ºç‹€æ…‹ï¼šé¡¯ç¤ºå¼•å°æŒ‰éˆ• â˜…â˜…â˜…
            listArea.innerHTML = `
                <div class="flex flex-col items-center justify-center py-8 text-center">
                    <div class="text-slate-300 text-4xl mb-2"><i class="fa-regular fa-folder-open"></i></div>
                    <p class="text-xs text-slate-400 mb-4">ç›®å‰æ²’æœ‰è¨­å®šä»»ä½•æˆç¸¾åˆ†é </p>
                    <button onclick="jumpToLinkSettings()" class="bg-blue-50 text-blue-600 px-4 py-2 rounded-lg text-xs font-bold hover:bg-blue-100 transition-colors">
                        <i class="fa-solid fa-gear mr-1"></i> å‰å¾€é€£çµè¨­å®š
                    </button>
                </div>`; 
            return; 
        }
        
        listArea.innerHTML = sheets.map(s => `
            <button onclick="handleSheetClick(this, '${s}')" class="sheet-btn w-full text-left px-4 py-3 rounded-lg text-sm font-bold text-slate-600 hover:bg-blue-50 hover:text-blue-600 transition-all border border-transparent focus:outline-none flex justify-between items-center group">
                <span class="truncate">${s}</span><i class="fa-solid fa-chevron-right text-xs opacity-0 group-hover:opacity-100 text-blue-400"></i>
            </button>`).join('');
     }).getSheetList(appData.currentClass.url);
    }

    // è¼”åŠ©å‡½å¼ï¼šè·³è½‰åˆ°é€£çµè¨­å®šé é¢
    function jumpToLinkSettings() {
        // 1. åˆ‡æ›åˆ°é€£çµç®¡ç† View
        switchView('link');
        
        // 2. è‡ªå‹•éæ¿¾å‡ºç•¶å‰ç­ç´šçš„å¡ç‰‡ (é€éè§¸ç™¼æœå°‹æˆ–ç›´æ¥å®šä½)
        // é€™è£¡ç°¡å–®åšï¼šé‡æ–°æ¸²æŸ“åˆ—è¡¨ï¼Œè®“ä½¿ç”¨è€…è‡ªå·±æ‰¾
        if(typeof renderSettingsView === 'function') renderSettingsView();
        
        // 3. æç¤ºä½¿ç”¨è€…
        showToast("æç¤º", "è«‹æ‰¾åˆ°å°æ‡‰ç­ç´šä¸¦é»æ“Šã€Œç·¨è¼¯è¨­å®šã€ä¾†æ–°å¢åˆ†é ", "info",3000);
    }

  // ç¼ºäº¤æƒæ (ç¶­æŒä¸è®Š)
  function scanMissing() {
    const targets = appData.currentClass.targets;
    if(!targets || targets.length === 0) return showToast("éŒ¯èª¤","è«‹å…ˆåœ¨è¨­å®šé è¨­å®šç›£æ§åˆ†é ","error",3000);
    const btn = document.getElementById('btn-scan'); const originalHtml = btn.innerHTML; btn.innerHTML = '<div class="loader"></div>';
    google.script.run.withSuccessHandler(res => {
       btn.innerHTML = originalHtml;
       if(!res.success) return showToast("éŒ¯èª¤", res.msg, "error",5000);
       if(res.data.length === 0) return showToast("å¾ˆæ£’", "æ‰€æœ‰åˆ†é çš†ç„¡ç¼ºäº¤ï¼", "success",1000);
       batchData = { type: 'missing', sheetName: 'All Sheets', list: res.data, currentIndex: 0 }; 
       openModal();
    }).apiScanAllClassTargets(appData.currentClass.url, targets, appData.currentClass.days);
  }

  // â˜…â˜…â˜… v8.4 å°å¸«ç¸½è¡¨æ ¸å¿ƒé‚è¼¯ â˜…â˜…â˜…
  
  let cachedMasterData = []; // å…¨åŸŸå¿«å–è³‡æ–™
  let selectedSheets = new Set(); // v8.6: å„²å­˜è¢«å‹¾é¸çš„åˆ†é  Key (æ ¼å¼: "ç§‘ç›®åç¨±_åˆ†é åç¨±")

  function openMasterSheet() {
      document.getElementById('dash-picker').classList.add('hidden');
      document.getElementById('dash-content-master').classList.remove('hidden');
      
      // å¦‚æœå·²ç¶“æœ‰å¿«å–è³‡æ–™ï¼Œç›´æ¥é¡¯ç¤ºï¼Œä¸ç”¨é‡æŠ“
      if(cachedMasterData.length > 0) {
          applyMasterFilters();
      }
  }

  // 1. åŒæ­¥è³‡æ–™ (Call Backend)
  // 1. åŒæ­¥è³‡æ–™
  // 1. åŒæ­¥è³‡æ–™
  function syncMasterData() {
      const loading = document.getElementById('master-loading');
      const empty = document.getElementById('master-empty');
      const tbody = document.getElementById('master-tbody');
      const statusDiv = document.getElementById('master-status');
      
      loading.classList.remove('hidden');
      empty.classList.add('hidden');
      tbody.innerHTML = '';
      statusDiv.innerText = "æ­£åœ¨æº–å‚™åŒæ­¥...";

      // Helper: Promise Wrapper for google.script.run
      const runServerFn = (fnName, ...args) => {
          return new Promise((resolve, reject) => {
             google.script.run
                .withSuccessHandler(resolve)
                .withFailureHandler(reject)
                [fnName](...args);
          });
      };

      // Step 1: å–å¾—ç­ç´šæ¸…å–®
      runServerFn('apiGetHomeroomList')
         .then(list => {
             if(!list || list.length === 0) throw new Error("å°šæœªè¨­å®šä»»ä½•ä»»èª²é€£çµ");
             
             statusDiv.innerText = `æº–å‚™åŒæ­¥ ${list.length} å€‹ç­ç´š...`;
             
             // Step 2: å¹³è¡Œè«‹æ±‚
             const promises = list.map(config => {
                 return runServerFn('apiFetchSingleHomeroomData', config)
                        .then(res => {
                             if(res.success) {
                                 statusDiv.innerText = `å·²å®ŒæˆåŒæ­¥: ${config.name}`;
                                 return res;
                             } else {
                                 return { success: false, msg: res.msg, data: [], log: [] };
                             }
                        })
                        .catch(err => {
                             return { success: false, msg: err.message, data: [], log: [] };
                        });
             });
             
             return Promise.all(promises);
         })
         .then(results => {
             // Step 3: å½™æ•´è³‡æ–™
             let mergedData = [];
             let failures = [];
             
             results.forEach(r => {
                 if(r.success && r.data) {
                     mergedData = mergedData.concat(r.data);
                 } else {
                     if(r.msg) failures.push(r.msg);
                 }
             });
             
             // Step 4: æœ€çµ‚æ’åº (ä¾ç…§åº§è™Ÿ)
             mergedData.sort((a,b) => {
                  const seatA = parseInt(a.seatNo); const seatB = parseInt(b.seatNo);
                  if (!isNaN(seatA) && !isNaN(seatB)) return (seatA - seatB) || a.subject.localeCompare(b.subject);
                  return a.seatNo.localeCompare(b.seatNo) || a.subject.localeCompare(b.subject);
             });
             
             loading.classList.add('hidden');
             
             if(mergedData.length > 0) {
                 cachedMasterData = mergedData;
                 showToast("åŒæ­¥å®Œæˆ", `æˆåŠŸæŠ“å– ${mergedData.length} ç­†æˆç¸¾` + (failures.length>0?` (å¤±æ•— ${failures.length})`:""), "success", 3000);
                 
                 // åˆå§‹åŒ–ç¯©é¸å™¨
                 initAdvancedFilters(mergedData);
                 applyMasterFilters();
             } else {
                 showToast("åŒæ­¥ç„¡è³‡æ–™", failures.join(", ") || "ç„¡æˆç¸¾æ•¸æ“š", "warning", 5000);
                 empty.classList.remove('hidden');
             }
         })
         .catch(err => {
             loading.classList.add('hidden');
             showToast("åŒæ­¥å¤±æ•—", err.message, "error", 5000);
             empty.classList.remove('hidden');
         });
  }

  // 2. åˆå§‹åŒ–é€²éšç¯©é¸å™¨ (v8.6)
  function initAdvancedFilters(data) {
      // å­¸ç”Ÿä¸‹æ‹‰ (ç¶­æŒå–®é¸)
      const students = [...new Set(data.map(d => `${d.seatNo}|${d.name}`))].sort((a,b) => Number(a.split('|')[0]) - Number(b.split('|')[0]));
      const sel = document.getElementById('filter-student');
      sel.innerHTML = `<option value="all">å…¨éƒ¨å­¸ç”Ÿ</option>`;
      students.forEach(s => {
          const [seat, name] = s.split('|');
          sel.add(new Option(`${seat}è™Ÿ - ${name}`, s));
      });

      // å»ºç«‹ ç§‘ç›® -> åˆ†é  çš„çµæ§‹
      let sheetMap = {};
      data.forEach(d => {
          if(!sheetMap[d.subject]) sheetMap[d.subject] = new Set();
          sheetMap[d.subject].add(d.sheet);
      });

      // ç”Ÿæˆ Checkbox HTML
      const container = document.getElementById('filter-container');
      container.innerHTML = "";
      selectedSheets.clear(); // é‡ç½®é¸æ“‡

      Object.keys(sheetMap).sort().forEach(subject => {
          const sheets = [...sheetMap[subject]].sort();
          
          // å»ºç«‹åˆ†çµ„å¡ç‰‡
          const group = document.createElement('div');
          group.className = "bg-white p-4 rounded-lg shadow-sm border border-slate-200 mb-4";
          
          // æ¨™é¡Œèˆ‡å…¨é¸æŒ‰éˆ•
          group.innerHTML = `
             <div class="flex justify-between items-center mb-3 pb-2 border-b border-slate-100">
                <h4 class="font-bold text-slate-700 flex items-center">
                    <span class="w-1 h-4 bg-blue-500 rounded-full mr-2"></span>${subject}
                </h4>
                <button onclick="toggleGroup('${subject}', this)" class="text-xs text-blue-500 hover:underline">å…¨é¸/å–æ¶ˆ</button>
             </div>
             <div class="grid grid-cols-2 md:grid-cols-3 gap-3" id="group-${subject}"></div>
          `;
          
          container.appendChild(group);
          const grid = document.getElementById(`group-${subject}`);

          sheets.forEach(sheet => {
              const key = `${subject}_${sheet}`;
              selectedSheets.add(key); // é è¨­å…¨é¸

              const label = document.createElement('label');
              label.className = "flex items-center p-2 rounded hover:bg-slate-50 cursor-pointer border border-transparent hover:border-slate-200 transition-all";
              label.innerHTML = `
                  <input type="checkbox" value="${key}" class="filter-chk w-4 h-4 text-blue-600 rounded focus:ring-blue-500 border-slate-300 mr-2" checked>
                  <span class="text-sm text-slate-600 select-none truncate" title="${sheet}">${sheet}</span>
              `;
              grid.appendChild(label);
          });
      });
      
      updateFilterBtnText();
  }

  // --- ç¯©é¸å½ˆçª—æ§åˆ¶é‚è¼¯ ---
  function openFilterModal() { document.getElementById('filter-modal').classList.remove('hidden'); }
  function closeFilterModal() { document.getElementById('filter-modal').classList.add('hidden'); }
  
  function toggleGroup(subject, btn) {
      const inputs = document.querySelectorAll(`#group-${subject} input`);
      // æª¢æŸ¥æ˜¯å¦å…¨é¸ï¼Œè‹¥æ˜¯å‰‡å…¨å–æ¶ˆï¼Œå¦å‰‡å…¨é¸
      const allChecked = Array.from(inputs).every(i => i.checked);
      inputs.forEach(i => i.checked = !allChecked);
  }

  function toggleAllFilters(state) {
      document.querySelectorAll('.filter-chk').forEach(i => i.checked = state);
  }

  function confirmFilterSelection() {
      selectedSheets.clear();
      document.querySelectorAll('.filter-chk:checked').forEach(i => {
          selectedSheets.add(i.value);
      });
      
      updateFilterBtnText();
      applyMasterFilters();
      closeFilterModal();
  }

  function updateFilterBtnText() {
      const count = selectedSheets.size;
      const total = document.querySelectorAll('.filter-chk').length;
      const btnText = document.getElementById('filter-btn-text');
      
      if(count === total) btnText.innerText = "å…¨éƒ¨åˆ†é ";
      else if(count === 0) btnText.innerText = "ç„¡åˆ†é ";
      else btnText.innerText = `å·²é¸ ${count} å€‹åˆ†é `;
  }

  // 3. å¥—ç”¨ç¯©é¸ (v8.6)
  function applyMasterFilters() {
      const fStudent = document.getElementById('filter-student').value;
      const keyword = document.getElementById('filter-keyword').value.toLowerCase().trim();
      const sortMode = document.getElementById('sort-mode').value;

      // A. ç¯©é¸ (Filter)
      let filtered = cachedMasterData.filter(d => {
          const matchStudent = fStudent === 'all' || `${d.seatNo}|${d.name}` === fStudent;
          const key = `${d.subject}_${d.sheet}`;
          const matchSheet = selectedSheets.has(key);
          const matchKeyword = keyword === "" || 
                               d.task.toLowerCase().includes(keyword) || 
                               (d.date && d.date.includes(keyword));
          return matchStudent && matchSheet && matchKeyword;
      });

      // B. æ’åº (Sort)
      filtered.sort((a, b) => {
          // â˜…â˜…â˜… v8.8: ä½œæ¥­åˆ†çµ„æ’åº â˜…â˜…â˜…
          if (sortMode === 'task') {
             // 1. å…ˆæ¯”å°ä½œæ¥­åç¨± (ä½¿ç”¨ä¸­æ–‡èªç³»æ’åº)
             const res = a.task.localeCompare(b.task, "zh-TW");
             if (res !== 0) return res;
             
             // 2. ä½œæ¥­åç¨±ç›¸åŒæ™‚ï¼Œä¾ç…§åº§è™Ÿæ’åº
             const seatA = parseInt(a.seatNo);
             const seatB = parseInt(b.seatNo);
             if (!isNaN(seatA) && !isNaN(seatB)) return seatA - seatB;
             return a.seatNo.localeCompare(b.seatNo);
          }

          // å…¶ä»–æ—¢æœ‰æ’åºé‚è¼¯
          if (sortMode === 'score-desc') return b.score - a.score;
          if (sortMode === 'score-asc') return a.score - b.score;
          
          if (sortMode === 'date-desc' || sortMode === 'date-asc') {
             if (!a.date) return 1;
             if (!b.date) return -1;
             const res = a.date.localeCompare(b.date);
             return sortMode === 'date-desc' ? -res : res;
          }
          
          // Default: åº§è™Ÿ
          const seatA = parseInt(a.seatNo);
          const seatB = parseInt(b.seatNo);
          if (!isNaN(seatA) && !isNaN(seatB)) return (seatA - seatB) || a.subject.localeCompare(b.subject);
          return a.seatNo.localeCompare(b.seatNo);
      });

      renderMasterRows(filtered);
  }

  // v8.5 renderMasterRows
  function renderMasterRows(data) {
      const tbody = document.getElementById('master-tbody');
      const statusDiv = document.getElementById('master-status');
      
      document.getElementById('count-display').innerText = data.length;
      document.getElementById('count-fail').innerText = data.filter(d => Number(d.score) < 60).length;
      
      if(data.length === 0) {
          tbody.innerHTML = `<tr><td colspan="8" class="p-8 text-center text-slate-400">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</td></tr>`;
          return;
      }

      let html = data.map((d, i) => {
          const score = Number(d.score);
          const isFail = !isNaN(score) && score < 60;
          const scoreClass = isFail ? "text-red-600 font-bold bg-red-50" : "text-slate-700 font-bold";
          
          let rankHtml = `<span class="text-slate-500">${escapeHtml(d.rank)}</span>`;
          if (d.rank === 1) rankHtml = `<span class="bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full text-xs font-bold">ğŸ¥‡ 1</span>`;
          else if (d.rank === 2) rankHtml = `<span class="bg-gray-100 text-slate-600 px-2 py-0.5 rounded-full text-xs font-bold">ğŸ¥ˆ 2</span>`;
          else if (d.rank === 3) rankHtml = `<span class="bg-orange-50 text-orange-700 px-2 py-0.5 rounded-full text-xs font-bold">ğŸ¥‰ 3</span>`;

          const statsJson = JSON.stringify(d.stats).replace(/"/g, '&quot;');
          const infoJson = JSON.stringify({t:d.task, s:d.subject, sh:d.sheet}).replace(/"/g, '&quot;');
          
          // æ—¥æœŸé¡¯ç¤º (è‹¥ç„¡æ—¥æœŸé¡¯ç¤º - )
          const dateHtml = d.date ? `<span class="text-slate-600 font-mono bg-slate-50 px-1 rounded">${d.date}</span>` : `<span class="text-slate-300">-</span>`;

          return `
            <tr class="hover:bg-blue-50 border-b border-slate-50 transition-colors group">
                <td class="p-3 text-center font-mono text-slate-500">${escapeHtml(d.seatNo)}</td>
                <td class="p-3 font-bold text-slate-700">${escapeHtml(d.name)}</td>
                <td class="p-3"><span class="bg-purple-100 text-purple-700 text-xs px-2 py-1 rounded">${escapeHtml(d.subject)}</span></td>
                
                <td class="p-3 text-center">${dateHtml}</td>
                
                <td class="p-3 text-xs text-slate-500 truncate max-w-[150px]" title="${escapeHtml(d.sheet)}">${escapeHtml(d.sheet)}</td>
                <td class="p-3 text-sm text-slate-600 cursor-pointer" onclick="openStatsModal(${statsJson}, ${infoJson})">
                    <span class="group-hover:text-blue-600 transition-colors border-b border-dashed border-transparent group-hover:border-blue-400">
                        ${escapeHtml(d.task)} <i class="fa-solid fa-chart-simple ml-1 text-slate-300 group-hover:text-blue-500"></i>
                    </span>
                </td>
                <td class="p-3 text-center ${scoreClass}">${d.score}</td>
                <td class="p-3 text-center">${rankHtml}</td>
            </tr>
          `;
      }).join('');

      tbody.innerHTML = html;
      statusDiv.innerText = `æœ€å¾Œæ›´æ–°ï¼š${new Date().toLocaleTimeString()}`;
  }
  
  function openStatsModal(stats, info) {
      if(!stats) return showToast("ç„¡æ•¸æ“š", "æ­¤é …ç›®ç„¡æ³•è¨ˆç®—çµ±è¨ˆè³‡æ–™", "warning",5000);
      document.getElementById('stats-modal').classList.remove('hidden');
      document.getElementById('st-task').innerText = info.t;
      document.getElementById('st-sub').innerText = `${info.s} / ${info.sh}`;
      document.getElementById('st-avg').innerText = stats.avg;
      document.getElementById('st-max').innerText = stats.max;
      document.getElementById('st-min').innerText = stats.min;
      if(stats.five) {
          document.getElementById('st-p88').innerText = stats.five.top;
          document.getElementById('st-p75').innerText = stats.five.front;
          document.getElementById('st-p50').innerText = stats.five.avg;
          document.getElementById('st-p25').innerText = stats.five.back;
          document.getElementById('st-p12').innerText = stats.five.bottom;
      }
      const distEl = document.getElementById('st-dist');
      const maxCount = Math.max(...Object.values(stats.dist));
      const labels = { '100':'100åˆ†', '90-99':'90-99', '80-89':'80-89', '70-79':'70-79', '60-69':'60-69', 'below60':'ä¸åŠæ ¼' };
      const colors = { '100':'bg-green-500', '90-99':'bg-green-400', '80-89':'bg-blue-400', '70-79':'bg-blue-300', '60-69':'bg-yellow-400', 'below60':'bg-red-400' };
      let html = "";
      Object.keys(labels).forEach(k => {
          const count = stats.dist[k];
          const pct = maxCount > 0 ? (count / maxCount) * 100 : 0;
          html += `<div class="flex items-center"><div class="w-12 text-slate-500 text-right mr-2">${labels[k]}</div><div class="flex-1 bg-slate-100 rounded-full h-2 overflow-hidden"><div class="${colors[k]} h-full rounded-full" style="width: ${pct}%"></div></div><div class="w-6 text-left ml-2 font-bold text-slate-600">${count}</div></div>`;
      });
      distEl.innerHTML = html;
  }

  // â˜…â˜…â˜… v10.5: é–‹å•Ÿè³‡æ–™åº«è¨­å®š Modal â˜…â˜…â˜…
  function openDbConfigModal() {
      document.getElementById('db-config-modal').classList.remove('hidden');
      
      // è®€å–ç›®å‰çš„è¨­å®š
      if(typeof loadDbConfig === 'function') loadDbConfig();
  }

  function testDbLink() {
      const url = document.getElementById('db-url').value.trim();
      if(!url) return showToast("éŒ¯èª¤", "è«‹è¼¸å…¥ç¶²å€", "error",5000);
      window.open(url, '_blank');
  }
  const originalLoadDbConfig = window.loadDbConfig;
  window.loadDbConfig = function() {
      google.script.run.withSuccessHandler(url => {
          if(url) {
              const input = document.getElementById('db-url');
              if(input) input.value = url;
              
              // å˜—è©¦è®€å–æœ€å¾Œæ›´æ–°æ™‚é–“ (å¯é¸ï¼Œéœ€å¾Œç«¯æ”¯æ´ï¼Œç›®å‰å…ˆé¡¯ç¤ºéœæ…‹æ–‡å­—)
              const statusDiv = document.getElementById('db-last-sync');
              if(statusDiv) statusDiv.innerText = "æœ€å¾ŒåŒæ­¥ï¼š(è«‹åƒè€ƒè³‡æ–™åº«æª”æ¡ˆ)";
          }
      }).apiGetDbUrl();
  }

  // â˜…â˜…â˜… v8.9: ç¼ºäº¤é è¦½ä¿¡æ¸¬è©¦ (ç§»è‡³æ­¤è™•) â˜…â˜…â˜…
  function sendPreviewSummary() {
      const btn = document.getElementById('btn-test-preview');
      const orgHtml = btn.innerHTML;
      
      // 1. é–å®šæŒ‰éˆ•é¿å…é‡è¤‡é»æ“Š
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> æƒæä¸­...';
      btn.disabled = true;
      btn.classList.add('bg-slate-100', 'text-slate-400'); // è¦–è¦ºç°éšåŒ–

      // 2. å‘¼å«å¾Œç«¯
      google.script.run.withSuccessHandler(res => {
          // 3. é‚„åŸæŒ‰éˆ•
          btn.innerHTML = '<i class="fa-solid fa-check mr-2"></i> å·²ç™¼é€';
          setTimeout(() => {
              btn.innerHTML = orgHtml;
              btn.disabled = false;
              btn.classList.remove('bg-slate-100', 'text-slate-400');
          }, 3000); // 3ç§’å¾Œè®Šå›åŸæ¨£
          
          showToast("å®Œæˆ", "é è¦½ä¿¡å·²å¯„å‡ºï¼Œè«‹æª¢æŸ¥æ‚¨çš„ä¿¡ç®±", "success",1000);
          
      }).withFailureHandler(err => {
          btn.innerHTML = orgHtml;
          btn.disabled = false;
          btn.classList.remove('bg-slate-100', 'text-slate-400');
          showToast("éŒ¯èª¤", "ç™¼é€å¤±æ•—ï¼š" + err.message, "error",5000);
      }).triggerPreviewSummary(); // å‘¼å«å¾Œç«¯å‰›å‰›å¯«å¥½çš„å‡½å¼
  }
</script>