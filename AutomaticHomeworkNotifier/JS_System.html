<script>
    /**
     * JS_System: 管理系統資安金鑰與查詢端同步工具
     */

    function renderSystemView() {
        checkSaltStatus();
        initTriggerHours();
        loadTriggerSettings();
    }

    function initTriggerHours() {
        const createOpts = (selId) => {
            const sel = document.getElementById(selId);
            if(!sel) return;
            sel.innerHTML = "";
            for(let i=0; i<24; i++) {
                const hour = i < 10 ? "0"+i : i;
                sel.add(new Option(`每天 ${hour}:00`, i));
            }
        };
        createOpts('sel-notify-hour');
        createOpts('sel-sync-hour');
    }

    function loadTriggerSettings() {
        google.script.run.withSuccessHandler(res => {
            if(res.success) {
                const s = res.settings;
                // 1. Daily Notify
                const tgNotify = document.getElementById('tg-auto-notify');
                if(tgNotify) {
                    tgNotify.checked = s.triggerDailyAutomation.enabled;
                    document.getElementById('sel-notify-hour').value = s.triggerDailyAutomation.hour;
                }
                
                // 2. DB Sync
                const tgSync = document.getElementById('tg-auto-sync');
                if(tgSync) {
                    tgSync.checked = s.apiSyncToDatabase.enabled;
                    document.getElementById('sel-sync-hour').value = s.apiSyncToDatabase.hour;
                }
            }
        }).apiGetTriggerSettings();
    }

    function saveTriggerSettings() {
        const btn = document.getElementById('btn-save-trigger');
        const orgHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> 儲存中...';
        btn.disabled = true;

        const config = {
            triggerDailyAutomation: {
                enabled: document.getElementById('tg-auto-notify').checked,
                hour: parseInt(document.getElementById('sel-notify-hour').value)
            },
            apiSyncToDatabase: {
                enabled: document.getElementById('tg-auto-sync').checked,
                hour: parseInt(document.getElementById('sel-sync-hour').value)
            }
        };

        google.script.run.withSuccessHandler(res => {
            btn.innerHTML = orgHtml;
            btn.disabled = false;
            if(res.success) {
                showToast("成功", "排程設定已更新", "success", 1000);
            } else {
                showToast("錯誤", res.msg, "error", 5000);
            }
        }).apiSaveTriggerSettings(config);
    }

    function checkSaltStatus() {
       const msg = document.getElementById('salt-status-msg');
       msg.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>檢查狀態中...';
       
       google.script.run.withSuccessHandler(res => {
           if(res.isSet) {
               msg.innerHTML = '<i class="fa-solid fa-check-circle text-emerald-500 mr-2"></i>系統目前<span class="text-emerald-600">已設定</span>金鑰 (輸入新值可覆蓋)';
               document.getElementById('btn-copy-config').classList.remove('hidden'); // 顯示同步工具
           } else {
               msg.innerHTML = '<i class="fa-solid fa-triangle-exclamation text-amber-500 mr-2"></i>尚未設定金鑰 (建議立即設定)';
               document.getElementById('btn-copy-config').classList.add('hidden');
           }
       }).apiCheckSaltStatus();
    }

    /**
     * 複製查詢端所需的設定字串 (Salt + DB_URL)
     */
    function copyConfigForPortal() {
        const btn = document.getElementById('btn-copy-config');
        const orgHtml = btn.innerHTML;
        
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>讀取中...';
        btn.disabled = true;

        google.script.run.withSuccessHandler(res => {
            if (res.success) {
                // Try modern clipboard API first
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(res.text).then(() => {
                        showCopySuccess(btn, orgHtml);
                    }).catch(err => {
                        console.warn("Clipboard API failed, trying fallback...", err);
                        fallbackCopyTextToClipboard(res.text, btn, orgHtml);
                    });
                } else {
                    fallbackCopyTextToClipboard(res.text, btn, orgHtml);
                }
            } else {
                alert(res.msg);
                btn.innerHTML = orgHtml;
                btn.disabled = false;
            }
        }).apiGetConfigForCopy();
    }

    function showCopySuccess(btn, orgHtml) {
        btn.innerHTML = '<i class="fa-solid fa-check mr-2"></i>已複製設定資訊';
        setTimeout(() => { btn.innerHTML = orgHtml; btn.disabled = false; }, 2000);
    }

    function fallbackCopyTextToClipboard(text, btn, orgHtml) {
        try {
            var textArea = document.createElement("textarea");
            textArea.value = text;
            
            // Ensure it's not visible but part of DOM
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            var successful = document.execCommand('copy');
            document.body.removeChild(textArea);
            
            if (successful) {
                showCopySuccess(btn, orgHtml);
            } else {
                throw new Error("execCommand failed");
            }
        } catch (err) {
            console.error('Fallback: Oops, unable to copy', err);
            prompt("複製失敗，請手動複製以下內容：", text);
            btn.innerHTML = orgHtml;
            btn.disabled = false;
        }
    }

    function saveSystemSalt() {
      const inp = document.getElementById('inp-sys-salt');
      const btn = document.getElementById('btn-save-salt');
      const salt = inp.value.trim();

      if (!salt) return showToast("錯誤", "請輸入金鑰內容", "error",5000);

      const orgText = btn.innerHTML;
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>儲存中...';
      btn.disabled = true;

      google.script.run.withSuccessHandler(res => {
          btn.innerHTML = orgText;
          btn.disabled = false;
          if (res.success) {
            inp.value = "";
            showToast("成功", "系統金鑰已更新", "success",1000);
            checkSaltStatus();
          } else {
            showToast("失敗", res.msg, "error",5000);
          }
      }).apiSaveSystemSalt(salt);
    }

    function doArchive() {
        if(!confirm("⚠️ 確定要封存目前的成績資料嗎？\n\n這通常在「新學期開始」時執行。\n舊資料將被移至 History 分頁，查詢端將被清空。")) return;

        const btn = document.getElementById('btn-archive');
        const orgHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> 處理中...';
        btn.disabled = true;

        google.script.run.withSuccessHandler(res => {
            btn.innerHTML = orgHtml;
            btn.disabled = false;
            
            if(res.success) {
                alert(`✅ 封存成功！\n\n舊資料已移動至 [${res.archiveName}]。\n資料庫已重置，請記得執行「同步最新成績」來匯入新學期資料。`);
            } else {
                alert("❌ " + res.msg);
            }
        }).apiArchiveDatabase();
    }



    function jumpToDbCreator() {
        // 1. 隱藏所有主要頁面 (View)
        document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
        
        // 2. 顯示建立工廠頁面
        const creatorView = document.getElementById('view-creator');
        if (creatorView) {
            creatorView.classList.remove('hidden');
            creatorView.classList.add('flex'); // 確保 flex 排版正常
        }
        
        // 3. 呼叫建立工廠的初始化函式，並切換到 DB 工具分頁
        if (typeof openCreatorTool === 'function') {
            openCreatorTool('db');
        } else {
            console.error("找不到 openCreatorTool 函式，請確認 JS_Creator.html 是否已載入");
        }
    }
</script>