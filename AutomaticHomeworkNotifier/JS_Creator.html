<script>
    /**
     * JS_Creator.html (Modal Fix & Table Logic)
     */

    let currentFolderId = ""; 
    let currentParentId = ""; 

    function initCreator() {
        refreshFolderInfo();
        addBatchRow();
    }

    // --- Modal 控制 (新) ---
    function openDriveBrowser() {
        document.getElementById('drive-browser-modal').classList.remove('hidden');
        // 如果清單是空的，自動載入根目錄
        if(document.getElementById('drive-browser-list').children.length === 0) {
            browseDrive(); 
        }
    }

    function closeDriveBrowser() {
        document.getElementById('drive-browser-modal').classList.add('hidden');
        // 重置按鈕狀態
        const btn = document.getElementById('btn-set-folder');
        btn.innerText = "確認設定";
        btn.classList.remove('bg-amber-600', 'ring-2', 'ring-amber-200');
        btn.classList.add('bg-amber-500');
        pendingFolderId = "";
    }

    // --- 核心導航 ---
    function openCreatorTool(toolId) {
        document.getElementById('creator-header-section').classList.add('hidden');
        document.getElementById('creator-menu').classList.add('hidden');
        document.getElementById('creator-workspace').classList.remove('hidden');
        
        const titles = {
            'single': '<span class="text-blue-600 bg-blue-50 px-2 py-1 rounded text-sm mr-2"><i class="fa-solid fa-file-invoice"></i></span> 成績單範本',
            'batch': '<span class="text-indigo-600 bg-indigo-50 px-2 py-1 rounded text-sm mr-2"><i class="fa-solid fa-industry"></i></span> 批次建立工廠',
            'db': '<span class="text-emerald-600 bg-emerald-50 px-2 py-1 rounded text-sm mr-2"><i class="fa-solid fa-database"></i></span> 資料中繼站'
        };
        document.getElementById('workspace-title').innerHTML = titles[toolId] || "工具";

        document.querySelectorAll('.creator-tool-panel').forEach(el => el.classList.add('hidden'));
        const activePanel = document.getElementById('tool-' + toolId);
        if(activePanel) {
            activePanel.classList.remove('hidden');
            if(toolId === 'batch') activePanel.classList.add('flex');
        }

        // Toolbar
        const batchToolbar = document.getElementById('batch-toolbar');
        if (toolId === 'batch') batchToolbar.classList.remove('hidden');
        else batchToolbar.classList.add('hidden');
    }

    function backToCreatorMenu() {
        document.getElementById('creator-workspace').classList.add('hidden');
        document.getElementById('creator-header-section').classList.remove('hidden');
        document.getElementById('creator-menu').classList.remove('hidden');
        document.getElementById('batch-log-container').classList.add('hidden');
        document.getElementById('db-result-link').classList.add('hidden');
    }

    // --- 資料夾邏輯 ---
    function refreshFolderInfo() {
        const display = document.getElementById('current-folder-display');
        const link = document.getElementById('link-open-drive');
        display.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
        google.script.run.withSuccessHandler(res => {
            if(res.success) {
                display.innerText = res.name || "根目錄";
                currentFolderId = res.id;
                if(res.id) { link.href = "https://drive.google.com/drive/folders/" + res.id; link.classList.remove('pointer-events-none', 'opacity-50', 'bg-slate-300'); link.classList.add('bg-amber-500', 'hover:bg-amber-600'); } 
                else { link.href = "https://drive.google.com/drive/my-drive"; }
            }
        }).apiGetStorageFolder();
    }

    function browseDrive(folderId) {
        const list = document.getElementById('drive-browser-list');
        const path = document.getElementById('browser-path');
        const btnUp = document.getElementById('btn-nav-up');
        
        list.innerHTML = '<div class="text-center text-slate-400 py-10"><i class="fa-solid fa-spinner fa-spin mr-2"></i>載入中...</div>';
        
        google.script.run.withSuccessHandler(res => {
            if(!res.success) { list.innerHTML = '<div class="text-red-400 text-center py-4">讀取失敗</div>'; return; }
            
            path.innerText = res.current.name;
            currentParentId = res.parent; 
            btnUp.disabled = !res.parent; 
            if(!res.parent) btnUp.classList.add('opacity-50', 'cursor-not-allowed');
            else btnUp.classList.remove('opacity-50', 'cursor-not-allowed');

            list.innerHTML = '';
            if(res.children.length === 0) list.innerHTML = '<div class="text-center text-slate-300 py-8 text-xs italic">此資料夾為空</div>';
            else {
                res.children.forEach(folder => {
                    const div = document.createElement('div');
                    div.className = "flex items-center justify-between p-3 hover:bg-slate-100 rounded-lg cursor-pointer group transition-colors border border-transparent hover:border-slate-200 mb-1";
                    div.innerHTML = `
                        <div class="flex items-center gap-3 min-w-0 flex-1" onclick="browseDrive('${folder.id}')">
                            <i class="fa-solid fa-folder text-amber-400 text-xl group-hover:text-amber-500 transition-colors"></i> 
                            <span class="text-slate-700 font-bold truncate text-sm">${folder.name}</span>
                        </div>
                        <button onclick="selectFolder('${folder.id}', '${folder.name}')" class="flex-shrink-0 text-xs bg-white border border-slate-200 text-slate-500 hover:text-amber-600 hover:border-amber-300 px-3 py-1.5 rounded transition-all shadow-sm">選取</button>
                    `;
                    list.appendChild(div);
                });
            }
        }).apiBrowseDrive(folderId);
    }

    let pendingFolderId = "";
    function selectFolder(id, name) {
        pendingFolderId = id;
        const btn = document.getElementById('btn-set-folder');
        btn.innerText = `設定為：${name}`;
        btn.classList.add('bg-amber-600', 'ring-2', 'ring-amber-200');
        btn.classList.remove('bg-amber-500');
    }

    function saveCurrentFolder() {
        if(!pendingFolderId) return alert("請先從列表中點擊「選取」按鈕");
        const btn = document.getElementById('btn-set-folder');
        btn.innerText = "儲存中...";
        btn.disabled = true;

        google.script.run.withSuccessHandler(res => {
            if(res.success) {
                showToast("設定成功", `已更新預設存檔位置：${res.folderName}`, "success");
                refreshFolderInfo();
                closeDriveBrowser(); // 成功後關閉 Modal
            } else {
                alert(res.msg);
            }
            btn.innerText = "確認設定";
            btn.disabled = false;
        }).apiSaveStorageFolder(pendingFolderId);
    }

    // --- 表格操作邏輯 ---
    function addBatchRow() {
        const tbody = document.getElementById('batch-table-body');
        const rowId = 'row-' + Date.now();
        const tr = document.createElement('tr');
        tr.className = "batch-row hover:bg-slate-50 transition-colors group border-b border-slate-100";
        tr.id = rowId;
        
        tr.innerHTML = `
            <td class="py-3 px-4 text-slate-300 font-mono text-xs select-none">
                <i class="fa-solid fa-grip-vertical group-hover:text-slate-400"></i>
            </td>
            <td class="py-2 px-2">
                <input type="text" class="inp-title w-full border border-slate-200 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-shadow" placeholder="例: 國文_701">
            </td>
            <td class="py-2 px-2">
                <input type="text" class="inp-sheets w-full border border-slate-200 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-shadow" value="第一次段考, 第二次段考, 平時成績">
            </td>
            <td class="py-2 px-2">
                <input type="text" class="inp-editor w-full border border-slate-200 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-shadow" placeholder="助教Email (選填)">
            </td>
            <td class="py-2 px-2 text-center">
                <input type="checkbox" class="inp-public w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500 cursor-pointer">
            </td>
            <td class="py-2 px-2 text-center">
                <button onclick="removeBatchRow('${rowId}')" class="text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-full w-8 h-8 transition-all flex items-center justify-center" title="刪除此列">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    }

    function removeBatchRow(id) {
        const row = document.getElementById(id);
        if(row) row.remove();
        if(document.getElementById('batch-table-body').children.length === 0) addBatchRow();
    }

    // --- 執行邏輯 ---
    function runSingleCreate() {
        const title = document.getElementById('inp-single-title').value.trim();
        const sheetsStr = document.getElementById('inp-single-sheets').value.trim();
        if(!title) { showToast("缺少資訊", "請輸入檔案名稱", "error"); return; }
        const btn = document.getElementById('btn-create-single');
        const orgHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>建立中...'; btn.disabled = true;
        const config = { title: title, sheetsStr: sheetsStr.replace(/,/g, '\n'), permission: { isPublic: false }, studentList: null };
        google.script.run.withSuccessHandler(res => {
            btn.innerHTML = orgHtml; btn.disabled = false;
            if(res.success) { showToast("建立成功", "檔案已建立", "success"); window.open(res.results[0].url, '_blank'); } else showToast("建立失敗", res.msg, "error");
        }).apiBatchCreateTemplates([config]);
    }

    function runBatchCreate() {
        const rows = document.querySelectorAll('.batch-row');
        let configs = [];
        rows.forEach(row => {
            const title = row.querySelector('.inp-title').value.trim();
            if(!title) return;
            const sheetsStr = row.querySelector('.inp-sheets').value.trim();
            const editorEmail = row.querySelector('.inp-editor').value.trim();
            const isPublic = row.querySelector('.inp-public').checked;
            configs.push({ title: title, sheetsStr: sheetsStr.replace(/,/g, '\n'), permission: { isPublic: isPublic, editorEmail: editorEmail }, studentList: null });
        });
        if(configs.length === 0) { showToast("無效輸入", "請至少輸入一個檔案名稱", "error"); return; }
        
        const btn = document.getElementById('btn-run-batch-top');
        const orgHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>處理中...'; btn.disabled = true;
        
        const logArea = document.getElementById('batch-log-container');
        logArea.classList.remove('hidden');
        logArea.innerHTML = '<div class="animate-pulse">正在初始化系統排程...</div>';
        
        google.script.run.withSuccessHandler(res => {
            btn.innerHTML = orgHtml; btn.disabled = false;
            if(res.success) {
                let html = `<div class="mb-2 font-bold text-white border-b border-slate-600 pb-1">執行結果彙整 (${res.results.length} 筆)</div>`;
                res.results.forEach(r => { html += r.success ? `<div class="flex items-center gap-2 mb-1"><span class="text-green-400">✅</span> <a href="${r.url}" target="_blank" class="underline hover:text-white">${r.title}</a></div>` : `<div class="flex items-center gap-2 mb-1"><span class="text-red-400">❌</span> <span class="text-slate-300">${r.title}: ${r.error}</span></div>`; });
                logArea.innerHTML = html;
                showToast("批次完成", `成功建立 ${res.results.filter(r=>r.success).length} 個檔案`, "success");
            } else { logArea.innerHTML = `<div class="text-red-400 font-bold">❌ 系統錯誤: ${res.msg}</div>`; showToast("發生錯誤", res.msg, "error"); }
        }).apiBatchCreateTemplates(configs);
    }

    function createDatabase() {
        const name = document.getElementById('inp-db-name').value.trim();
        if(!name) { showToast("缺少資訊", "請輸入資料庫名稱", "error"); return; }
        const btn = document.getElementById('btn-create-db');
        const orgHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>建立中...'; btn.disabled = true;
        google.script.run.withSuccessHandler(res => {
            btn.innerHTML = orgHtml; btn.disabled = false;
            if(res.success) {
                const area = document.getElementById('db-result-link');
                area.classList.remove('hidden');
                area.innerHTML = `<i class="fa-solid fa-circle-check mt-1 text-emerald-600"></i><div><div class="font-bold">建立成功！</div><div class="text-sm mt-1">請將此檔案網址複製到「系統設定」頁面。</div><a href="${res.url}" target="_blank" class="inline-block mt-2 font-bold underline hover:text-emerald-950">開啟檔案</a></div>`;
                showToast("建立成功", "資料庫已準備就緒", "success");
            } else alert(res.msg);
        }).createDataHubSheet(name);
    }

    initCreator();
</script>