<script>
    /**
     * JS_Creator.html (Modal Fix & Table Logic)
     */

    let currentFolderId = ""; 
    let currentParentId = ""; 

    function initCreator() {
        refreshFolderInfo();
        addBatchRow();
    }
    // --- 工具函式：解析學生名單 ---
    function parseStudentList(str) {
        if (!str || !str.trim()) return null;
        return str.trim().split('\n').map(line => {
            // [修正] 支援 Tab(\t)、半形逗號(,)、全形逗號(，)、半形空白( )、全形空白(　)
            let parts = line.split(/[ \t,，　]+/); 
            return [
                parts[0] ? parts[0].trim() : "", 
                parts[1] ? parts[1].trim() : "", 
                parts[2] ? parts[2].trim() : ""
            ];
        }).filter(row => row[0] || row[1]);
    }

    // --- Modal 控制 (新) ---
    function openDriveBrowser() {
        document.getElementById('drive-browser-modal').classList.remove('hidden');
        // 如果清單是空的，自動載入根目錄
        if(document.getElementById('drive-browser-list').children.length === 0) {
            browseDrive(); 
        }
    }

    function closeDriveBrowser() {
        document.getElementById('drive-browser-modal').classList.add('hidden');
        // 重置按鈕狀態
        const btn = document.getElementById('btn-set-folder');
        btn.innerText = "確認設定";
        btn.classList.remove('bg-amber-600', 'ring-2', 'ring-amber-200');
        btn.classList.add('bg-amber-500');
        pendingFolderId = "";
    }

    // --- 核心導航 ---
    function openCreatorTool(toolId) {
        document.getElementById('creator-header-section').classList.add('hidden');
        document.getElementById('creator-menu').classList.add('hidden');
        document.getElementById('creator-workspace').classList.remove('hidden');
        
        const titles = {
            'batch': '<span class="text-indigo-600 bg-indigo-50 px-2 py-1 rounded text-sm mr-2"><i class="fa-solid fa-industry"></i></span> 批次建立工廠',
            'db': '<span class="text-emerald-600 bg-emerald-50 px-2 py-1 rounded text-sm mr-2"><i class="fa-solid fa-database"></i></span> 資料中繼站'
        };
        document.getElementById('workspace-title').innerHTML = titles[toolId] || "工具";

        document.querySelectorAll('.creator-tool-panel').forEach(el => el.classList.add('hidden'));
        const activePanel = document.getElementById('tool-' + toolId);
        if(activePanel) {
            activePanel.classList.remove('hidden');
            if(toolId === 'batch') activePanel.classList.add('flex');
        }

        // Toolbar
        const batchToolbar = document.getElementById('batch-toolbar');
        if (toolId === 'batch') batchToolbar.classList.remove('hidden');
        else batchToolbar.classList.add('hidden');
    }

    function backToCreatorMenu() {
        document.getElementById('creator-workspace').classList.add('hidden');
        document.getElementById('creator-header-section').classList.remove('hidden');
        document.getElementById('creator-menu').classList.remove('hidden');
        document.getElementById('batch-log-container').classList.add('hidden');
        document.getElementById('db-result-link').classList.add('hidden');
    }

    // --- 資料夾邏輯 ---
    // --- 資料夾邏輯 (Restored for v12.1) ---
    function refreshFolderInfo() {
        const display = document.getElementById('current-folder-display');
        if(display) {
             google.script.run.withSuccessHandler(res => {
                 if(res.success) {
                     display.innerText = res.name;
                     // Store current ID if needed
                 } else {
                     display.innerText = "尚未設定 (將存於根目錄)";
                 }
             }).apiGetStorageFolder();
        }
    }

    function browseDrive(folderId) {
        const list = document.getElementById('drive-browser-list');
        list.innerHTML = '<div class="p-4 text-center text-slate-400"><i class="fa-solid fa-spinner fa-spin mr-2"></i>讀取中...</div>';
        
        google.script.run.withSuccessHandler(res => {
            if(!res.success) {
                list.innerHTML = `<div class="p-4 text-center text-red-400">${res.msg}</div>`;
                return;
            }

            // Update Breadcrumbs / Navigation
            currentFolderId = res.current.id;
            currentParentId = res.parent;
            document.getElementById('browser-path').innerText = res.current.name;
            document.getElementById('btn-nav-up').disabled = !res.parent;
            
            // Render Children
            if(res.children.length === 0) {
                list.innerHTML = '<div class="p-8 text-center text-slate-300">此資料夾為空</div>';
            } else {
                let html = '';
                res.children.forEach(folder => {
                    html += `
                    <div class="flex items-center justify-between p-3 hover:bg-white rounded-lg group transition-colors cursor-pointer border border-transparent hover:border-indigo-100" onclick="browseDrive('${folder.id}')">
                        <div class="flex items-center gap-3">
                            <i class="fa-solid fa-folder text-amber-400 text-xl group-hover:scale-110 transition-transform"></i>
                            <span class="text-slate-700 font-bold text-sm">${escapeHtml(folder.name)}</span>
                        </div>
                        <button onclick="event.stopPropagation(); selectFolder('${folder.id}', '${escapeHtml(folder.name)}')" class="opacity-0 group-hover:opacity-100 bg-indigo-50 hover:bg-indigo-600 hover:text-white text-indigo-600 px-3 py-1 rounded text-xs font-bold transition-all transform scale-90 hover:scale-100">
                            選取
                        </button>
                    </div>`;
                });
                list.innerHTML = html;
            }
        }).apiBrowseDrive(folderId);
    }

    function selectFolder(id, name) {
        pendingFolderId = id;
        const btn = document.getElementById('btn-set-folder');
        btn.innerText = `確認設定: ${name}`;
        btn.classList.remove('bg-amber-500');
        btn.classList.add('bg-amber-600', 'ring-2', 'ring-amber-200');
        showToast("已選取", `準備設定為: ${name}`, "info");
    }

    function saveCurrentFolder() {
        if(!pendingFolderId) {
             // If user implies "Current Folder" (the one being browsed)
             if(currentFolderId) pendingFolderId = currentFolderId;
             else { showToast("未選取", "請選擇一個資料夾", "warning"); return; }
        }

        const btn = document.getElementById('btn-set-folder');
        const orgText = btn.innerText;
        btn.innerText = "儲存中..."; btn.disabled = true;

        google.script.run.withSuccessHandler(res => {
            btn.innerText = orgText; btn.disabled = false;
            if(res.success) {
                showToast("設定完成", `預設存檔位置已更新為: ${res.name}`, "success");
                refreshFolderInfo();
                closeDriveBrowser();
            } else {
                showToast("失敗", res.msg, "error");
            }
        }).apiSaveStorageFolder(pendingFolderId);
    }

    // --- 表格操作邏輯 ---
    function addBatchRow() {
        const tbody = document.getElementById('batch-table-body');
        const timestamp = Date.now();
        const rowId = 'row-' + timestamp;
        const detailId = 'detail-' + timestamp;
        
        // 1. Main Row
        const tr = document.createElement('tr');
        tr.className = "batch-row hover:bg-slate-50 transition-colors group border-b border-slate-100";
        tr.id = rowId;
        tr.dataset.detailId = detailId; // Link to detail row
        
        tr.innerHTML = `
            <td class="py-3 px-4 text-slate-300 font-mono text-xs select-none">
                <i class="fa-solid fa-grip-vertical group-hover:text-slate-400"></i>
            </td>
            <td class="py-2 px-2">
                <input type="text" class="inp-title w-full border border-slate-200 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-shadow" placeholder="例: 國文_701">
            </td>
            <td class="py-2 px-2">
                <input type="text" class="inp-sheets w-full border border-slate-200 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-shadow" value="第一次段考, 第二次段考, 平時成績">
            </td>
            <td class="py-2 px-2">
                <input type="text" class="inp-editor w-full border border-slate-200 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-shadow" placeholder="助教Email (選填)">
            </td>
            <td class="py-2 px-2 text-center">
                <input type="checkbox" class="inp-public w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500 cursor-pointer">
            </td>
            <td class="py-2 px-2 text-center flex items-center justify-center gap-2">
                <button onclick="toggleDetail('${detailId}')" class="text-slate-300 hover:text-indigo-600 hover:bg-indigo-50 rounded-full w-8 h-8 transition-all flex items-center justify-center" title="設定個別名單">
                    <i class="fa-solid fa-user-group"></i>
                </button>
                <button onclick="removeBatchRow('${rowId}')" class="text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-full w-8 h-8 transition-all flex items-center justify-center" title="刪除此列">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </td>
        `;

        // 2. Detail Row (Hidden)
        const trDetail = document.createElement('tr');
        trDetail.id = detailId;
        trDetail.className = "hidden bg-indigo-50/50 border-b border-indigo-100";
        trDetail.innerHTML = `
            <td colspan="6" class="p-4">
                <div class="flex items-start gap-4">
                    <div class="text-xs font-bold text-indigo-600 whitespace-nowrap pt-2"><i class="fa-solid fa-level-up-alt rotate-90 mr-2"></i>個別名單設定</div>
                    <div class="flex-1">
                         <div class="text-xs text-slate-500 mb-1">若填寫此處，將<span class="font-bold text-slate-700">優先</span>於上方統一名單。格式：<code>座號 姓名 Email</code></div>
                         <textarea class="inp-individual-students w-full bg-white border border-indigo-200 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none h-20 font-mono" placeholder="留空則使用統一設定"></textarea>
                    </div>
                </div>
            </td>
        `;

        tbody.appendChild(tr);
        tbody.appendChild(trDetail);
    }

    function toggleDetail(detailId) {
        const el = document.getElementById(detailId);
        if(el) {
            el.classList.toggle('hidden');
            // Visual feedback on the button? (Optional)
        }
    }

    function removeBatchRow(id) {
        const row = document.getElementById(id);
        if(row) {
            const detailId = row.dataset.detailId;
            if(detailId) {
                const detailRow = document.getElementById(detailId);
                if(detailRow) detailRow.remove();
            }
            row.remove();
        }
        if(document.getElementById('batch-table-body').children.length === 0) addBatchRow();
    }

    // --- 執行邏輯 ---


    function runBatchCreate() {
        const rows = document.querySelectorAll('.batch-row');
        const elBatchStudents = document.getElementById('inp-batch-students');
        const commonStudentStr = elBatchStudents ? elBatchStudents.value : "";
        const commonStudentList = parseStudentList(commonStudentStr);

        let configs = [];
        rows.forEach(row => {
            const title = row.querySelector('.inp-title').value.trim();
            if(!title) return;
            const sheetsStr = row.querySelector('.inp-sheets').value.trim();
            const editorEmail = row.querySelector('.inp-editor').value.trim();
            const isPublic = row.querySelector('.inp-public').checked;
            
            // Check Individual List
            const detailId = row.dataset.detailId;
            let finalStudentList = commonStudentList;
            
            if(detailId) {
                const detailRow = document.getElementById(detailId);
                if(detailRow) {
                    const indInput = detailRow.querySelector('.inp-individual-students');
                    const indStr = indInput ? indInput.value : "";
                    const indList = parseStudentList(indStr);
                    if(indList && indList.length > 0) {
                        finalStudentList = indList;
                    }
                }
            }

            configs.push({ 
                title: title, 
                sheetsStr: sheetsStr.replace(/,/g, '\n'), 
                permission: { isPublic: isPublic, editorEmail: editorEmail }, 
                studentList: finalStudentList
            });
        });

        if(configs.length === 0) { showToast("無效輸入", "請至少輸入一個檔案名稱", "error"); return; }

        const btn = document.getElementById('btn-run-batch-top');
        const orgHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>處理中...'; btn.disabled = true;
        const logArea = document.getElementById('batch-log-container');
        if(logArea) { logArea.classList.remove('hidden'); logArea.innerHTML = '<div class="animate-pulse">正在初始化系統排程...</div>'; }

        google.script.run.withSuccessHandler(res => {
            btn.innerHTML = orgHtml; btn.disabled = false;
            if(res.success) {
                let html = `<div class="mb-2 font-bold text-white border-b border-slate-600 pb-1">執行結果彙整 (${res.results.length} 筆)</div>`;
                res.results.forEach(r => { 
                    html += r.success ? `<div class="flex items-center gap-2 mb-1"><span class="text-green-400">✅</span> <a href="${r.url}" target="_blank" class="underline hover:text-white">${escapeHtml(r.title)}</a></div>` : `<div class="flex items-center gap-2 mb-1"><span class="text-red-400">❌</span> <span class="text-slate-300">${escapeHtml(r.title)}: ${escapeHtml(r.error)}</span></div>`; 
                });
                if(logArea) logArea.innerHTML = html;
                showToast("批次完成", `成功建立 ${res.results.filter(r=>r.success).length} 個檔案`, "success");
            } else { 
                if(logArea) logArea.innerHTML = `<div class="text-red-400 font-bold">❌ 系統錯誤: ${escapeHtml(res.msg)}</div>`; 
                showToast("發生錯誤", res.msg, "error"); 
            }
        }).apiBatchCreateTemplates(configs);
    }

    function createDatabase() {
        const name = document.getElementById('inp-db-name').value.trim();
        if(!name) { showToast("缺少資訊", "請輸入資料庫名稱", "error"); return; }
        const btn = document.getElementById('btn-create-db');
        const orgHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>建立中...'; btn.disabled = true;
        google.script.run.withSuccessHandler(res => {
            btn.innerHTML = orgHtml; btn.disabled = false;
            if(res.success) {
                const area = document.getElementById('db-result-link');
                area.classList.remove('hidden');
                area.innerHTML = `<i class="fa-solid fa-circle-check mt-1 text-emerald-600"></i><div><div class="font-bold">建立成功！</div><div class="text-sm mt-1">請將此檔案網址複製到「系統設定」頁面。</div><a href="${res.url}" target="_blank" class="inline-block mt-2 font-bold underline hover:text-emerald-950">開啟檔案</a></div>`;
                showToast("建立成功", "資料庫已準備就緒", "success");
            } else alert(res.msg);
        }).createDataHubSheet(name);
    }

    initCreator();
</script>